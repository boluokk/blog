<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>JUCå¹¶å‘ç¼–ç¨‹ | ğŸBlog</title><meta name="author" content="ğŸ"><meta name="copyright" content="ğŸ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹ï¼šå½“ä¸€ä¸ªç¨‹åºè¢«å¼€å¯ï¼Œå³å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ çº¿ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºå¤šä¸ªçº¿ç¨‹ã€ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµã€Javaä¸­çº¿ç¨‹æ˜¯æœ€å°çš„è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹æ˜¯ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ å¯¹æ¯”ï¼š  è¿›ç¨‹åŸºæœ¬ä¸Šæ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼ŒäºŒçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›† è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä½¿å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº« è¿›ç¨‹é—´é€šä¿¡æ›´å¤æ‚ çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•(å› ä¸ºå®ƒä»¬å…±äº«ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜)ï¼Œå¹¶ä¸”æ›´åŠ è½»é‡  çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢">
<meta property="og:type" content="article">
<meta property="og:title" content="JUCå¹¶å‘ç¼–ç¨‹">
<meta property="og:url" content="https://boluokk.github.io/blog/2023/08/27/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="ğŸBlog">
<meta property="og:description" content="è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹ï¼šå½“ä¸€ä¸ªç¨‹åºè¢«å¼€å¯ï¼Œå³å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ çº¿ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºå¤šä¸ªçº¿ç¨‹ã€ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµã€Javaä¸­çº¿ç¨‹æ˜¯æœ€å°çš„è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹æ˜¯ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ å¯¹æ¯”ï¼š  è¿›ç¨‹åŸºæœ¬ä¸Šæ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼ŒäºŒçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›† è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä½¿å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº« è¿›ç¨‹é—´é€šä¿¡æ›´å¤æ‚ çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•(å› ä¸ºå®ƒä»¬å…±äº«ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜)ï¼Œå¹¶ä¸”æ›´åŠ è½»é‡  çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.fomal.cc/img/default_cover_49.webp">
<meta property="article:published_time" content="2023-08-26T16:08:13.000Z">
<meta property="article:modified_time" content="2023-08-26T16:26:13.881Z">
<meta property="article:author" content="ğŸ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.fomal.cc/img/default_cover_49.webp"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="https://boluokk.github.io/blog/2023/08/27/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/blog/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JUCå¹¶å‘ç¼–ç¨‹',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-08-27 00:26:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://boluokk.gitee.io/blog/css/custom.css" media="defer" onload="this.media='all'"><script async src="https://boluokk.gitee.io/blog/js/fps.js"></script><script async src="https://boluokk.gitee.io/blog/js/title.js"></script><span id="fps"></span><div id="myscoll"></div><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/css/runtime/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/blog/assets/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/blog/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">18</div></a><a href="/blog/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/blog/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw icon-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw icon-guidang1"></i><span> å½’æ¡£</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://source.fomal.cc/img/default_cover_49.webp')"><nav id="nav"><span id="blog-info"><a href="/blog/" title="ğŸBlog"><span class="site-name">ğŸBlog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw icon-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw icon-guidang1"></i><span> å½’æ¡£</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JUCå¹¶å‘ç¼–ç¨‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-08-26T16:08:13.000Z" title="å‘è¡¨äº 2023-08-27 00:08:13">2023-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-08-26T16:26:13.881Z" title="æ›´æ–°äº 2023-08-27 00:26:13">2023-08-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">20.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>97åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="JUCå¹¶å‘ç¼–ç¨‹"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="è¿›ç¨‹ä¸çº¿ç¨‹"><a href="#è¿›ç¨‹ä¸çº¿ç¨‹" class="headerlink" title="è¿›ç¨‹ä¸çº¿ç¨‹"></a>è¿›ç¨‹ä¸çº¿ç¨‹</h3><blockquote>
<p>è¿›ç¨‹ï¼šå½“ä¸€ä¸ªç¨‹åºè¢«å¼€å¯ï¼Œå³å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹</p>
<p>çº¿ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºå¤šä¸ªçº¿ç¨‹ã€ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµã€Javaä¸­çº¿ç¨‹æ˜¯æœ€å°çš„è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹æ˜¯ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½</p>
<p>å¯¹æ¯”ï¼š</p>
<ol>
<li>è¿›ç¨‹åŸºæœ¬ä¸Šæ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼ŒäºŒçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†</li>
<li>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä½¿å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«</li>
<li>è¿›ç¨‹é—´é€šä¿¡æ›´å¤æ‚</li>
<li>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•(å› ä¸ºå®ƒä»¬å…±äº«ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜)ï¼Œå¹¶ä¸”æ›´åŠ è½»é‡ </li>
<li>çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä½</li>
</ol>
</blockquote>
<h3 id="å¹¶å‘-amp-å¹¶è¡Œ"><a href="#å¹¶å‘-amp-å¹¶è¡Œ" class="headerlink" title="å¹¶å‘&amp;å¹¶è¡Œ"></a>å¹¶å‘&amp;å¹¶è¡Œ</h3><blockquote>
<ul>
<li>å¹¶å‘ï¼šåŒä¸€æ—¶é—´åº”å¯¹å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</li>
<li>å¹¶è¡Œï¼šåŒä¸€æ—¶é—´åšå¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</li>
</ul>
</blockquote>
<h3 id="å¼‚æ­¥åŒæ­¥"><a href="#å¼‚æ­¥åŒæ­¥" class="headerlink" title="å¼‚æ­¥åŒæ­¥"></a>å¼‚æ­¥åŒæ­¥</h3><blockquote>
<ul>
<li><p>éœ€è¦ç­‰çº§ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</p>
</li>
<li><p>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</p>
</li>
</ul>
</blockquote>
<h5 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">FileReader</span> <span class="variable">fileReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;E:\\todo_files\\login.bat&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> fileReader.readString();</span><br><span class="line">    System.out.println(s);</span><br><span class="line">    log.debug(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æœ</span></span><br><span class="line">f:</span><br><span class="line">cd F:\pycharm\code\demo</span><br><span class="line">python Login.py</span><br><span class="line">pause</span><br><span class="line"><span class="number">18</span>:<span class="number">23</span>:<span class="number">38.423</span> asyncsync.Async [main] - hello</span><br></pre></td></tr></table></figure>

<h5 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt; &#123;</span><br><span class="line">        <span class="type">FileReader</span> <span class="variable">fileReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;E:\\todo_files\\login.bat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> fileReader.readString();</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;).start();</span><br><span class="line">    log.debug(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“æœ</span></span><br><span class="line"><span class="number">18</span>:<span class="number">25</span>:<span class="number">29.591</span> asyncsync.Sync [main] - hello</span><br><span class="line">f:</span><br><span class="line">cd F:\pycharm\code\demo</span><br><span class="line">python Login.py</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºè¿è¡Œçº¿ç¨‹"><a href="#åˆ›å»ºè¿è¡Œçº¿ç¨‹" class="headerlink" title="åˆ›å»ºè¿è¡Œçº¿ç¨‹"></a>åˆ›å»ºè¿è¡Œçº¿ç¨‹</h3><h5 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h5><blockquote>
<ol>
<li>ç»§æ‰¿æˆ–è€…ç›´æ¥new</li>
<li>é‡å†™runæ–¹æ³•</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c_thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="number">222</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.setName(<span class="string">&quot;child&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;main&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h5><blockquote>
<ol>
<li>å®ç°Runnableæ¥å£</li>
<li>é‡å†™runæ–¹æ³•</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c_runnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;child&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">c_runnable</span>()).start();</span><br><span class="line">        System.out.println(<span class="string">&quot;main&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Threadå’ŒRunnableåŒºåˆ«"><a href="#Threadå’ŒRunnableåŒºåˆ«" class="headerlink" title="Threadå’ŒRunnableåŒºåˆ«"></a>Threadå’ŒRunnableåŒºåˆ«</h5><blockquote>
<p>æ¨èä½¿ç”¨ Runnable: </p>
<ol>
<li>å› ä¸ºThreadæ˜¯çº¿ç¨‹å’Œä»»åŠ¡åœ¨ä¸€èµ·çš„ï¼Œå¹¶æ²¡æœ‰åˆ†å¼€ã€‚</li>
<li>Runnableæ˜¯å°†çº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€çš„ï¼Œä»è€Œæ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§APIé…åˆ</li>
<li>æ ¹æ®è®¾è®¡æ¨¡å¼åº”è¯¥å°½é‡ç”¨ç»„åˆæˆ–è€…èšåˆä»£æ›¿ç»§æ‰¿</li>
<li>å¹¶ä¸”Javaæ˜¯ç±»å•ç»§æ‰¿å¤šå®ç°çš„è¯­è¨€</li>
</ol>
</blockquote>
<h5 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h5><blockquote>
<p>ç»§æ‰¿äº†Runnable</p>
<p>runæ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">c_futuretask</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        FutureTask&lt;Integer&gt; fk = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;child&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(fk, <span class="string">&quot;fk&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        log.debug(<span class="string">&quot;è¿”å›å€¼: &#123;&#125;&quot;</span>, fk.get()); <span class="comment">// fk.get() ä¼šé˜»å¡, ç›´åˆ°æœ‰è¿”å›ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥çœ‹çº¿ç¨‹æ–¹æ³•"><a href="#æŸ¥çœ‹çº¿ç¨‹æ–¹æ³•" class="headerlink" title="æŸ¥çœ‹çº¿ç¨‹æ–¹æ³•"></a>æŸ¥çœ‹çº¿ç¨‹æ–¹æ³•</h3><h5 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h5><blockquote>
<ol>
<li>ä»»åŠ¡ç®¡ç†å™¨</li>
<li>tasklistæŸ¥çœ‹è¿›ç¨‹</li>
<li>taskkillæ€æ­»è¿›ç¨‹</li>
</ol>
</blockquote>
<h5 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h5><blockquote>
<ol>
<li>ps -fe æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li>
<li>ps -fT -p <PID> æŸ¥çœ‹æŸä¸ª</li>
<li>top -H -p <PID>æŸ¥çœ‹æŸä¸ªè¿›ç¨‹</li>
<li>kill æ€æ­»è¿›ç¨‹</li>
</ol>
</blockquote>
<h5 id="java"><a href="#java" class="headerlink" title="java"></a>java</h5><blockquote>
<ol>
<li>jps</li>
<li>jstack <PID>æŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li>
<li>jconsoleå¯ä»¥æŸ¥çœ‹(å¹¶ä¸”ä¹Ÿå¯ä»¥è¿œç¨‹)</li>
</ol>
</blockquote>
<h3 id="çº¿ç¨‹è¿è¡ŒåŸç†"><a href="#çº¿ç¨‹è¿è¡ŒåŸç†" class="headerlink" title="çº¿ç¨‹è¿è¡ŒåŸç†"></a>çº¿ç¨‹è¿è¡ŒåŸç†</h3><h5 id="æ ˆå’Œæ ˆå¸§"><a href="#æ ˆå’Œæ ˆå¸§" class="headerlink" title="æ ˆå’Œæ ˆå¸§"></a>æ ˆå’Œæ ˆå¸§</h5><blockquote>
<p> JVMæ˜¯ç”±å †ã€æ ˆã€æ–¹æ³•å»æ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™çº¿ç¨‹æ‰€ä½¿ç”¨ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºéƒ½ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜</p>
<ol>
<li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜</li>
<li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</li>
</ol>
</blockquote>
<h5 id="å›¾è§£"><a href="#å›¾è§£" class="headerlink" title="å›¾è§£"></a>å›¾è§£</h5><blockquote>
<p>cupè°ƒåº¦mainçº¿ç¨‹æ‰§è¡Œmainæ–¹æ³•ï¼ŒåŠ å…¥mainæ–¹æ³•çš„æ ˆå¸§ï¼Œå¹¶ä¸”mainæ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡argsæŒ‡å‘å †ä¸­ä¸­çš„ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œç„¶åè°ƒç”¨method1æ–¹æ³•ï¼ŒåŠ å…¥æ ˆå¸§ï¼Œåˆå§‹åŒ–ä¸€äº›å±€éƒ¨å˜é‡ï¼Œå¹¶ä¸”è¿”å›åœ°å€æŒ‡å‘è°ƒç”¨è€…ï¼Œæœ€åmethod2åŠ å…¥æ ˆå¸§åŒæ ·å±€éƒ¨å˜é‡næŒ‡å‘å †ä¸­çš„new Object(),è¿”å›åœ°å€æŒ‡å‘method1(è°ƒç”¨è€…)ï¼Œæœ€åmethod2æ‰§è¡Œå®Œæˆå¼¹å‡ºï¼Œç»§ç»­æ‰§è¡Œmethod1åå†å¼¹å‡ºï¼Œç„¶åå†æ‰§è¡Œmainæ–¹æ³•ï¼Œæ‰§è¡Œå®Œæˆåå¼¹å‡ºï¼Œç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230731212612803.png" alt="image-20230731212612803"></p>
<h5 id="çº¿ç¨‹ä¸Šä¸‹æ–‡"><a href="#çº¿ç¨‹ä¸Šä¸‹æ–‡" class="headerlink" title="çº¿ç¨‹ä¸Šä¸‹æ–‡"></a>çº¿ç¨‹ä¸Šä¸‹æ–‡</h5><blockquote>
<p>åº”ä¸ºä¸€äº›åŸå› å¯¼è‡´cpuä¸åœ¨æ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹</p>
<ul>
<li>çº¿ç¨‹cpuæ—¶é—´ç‰‡ç”¨å®Œ</li>
<li>åƒåœ¾å›æ”¶</li>
<li>æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦æ‰§è¡Œ</li>
<li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº†sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lockç­‰æ–¹æ³•</li>
</ul>
</blockquote>
<h3 id="çº¿ç¨‹å¸¸è§æ–¹æ³•"><a href="#çº¿ç¨‹å¸¸è§æ–¹æ³•" class="headerlink" title="çº¿ç¨‹å¸¸è§æ–¹æ³•"></a>çº¿ç¨‹å¸¸è§æ–¹æ³•</h3><h5 id="start"><a href="#start" class="headerlink" title="start()"></a>start()</h5><blockquote>
<p>å¯åŠ¨çº¿ç¨‹</p>
</blockquote>
<h5 id="getState"><a href="#getState" class="headerlink" title="getState()"></a>getState()</h5><blockquote>
<p>è·å–çº¿ç¨‹çŠ¶æ€ä¿¡æ¯</p>
</blockquote>
<h5 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h5><blockquote>
<p>ç¡çœ ï¼Œå°†çº¿ç¨‹æ­£åœ¨runningçŠ¶æ€æ”¹ä¸ºtimed waitingçŠ¶æ€</p>
<p>å¯ç”¨TimeUnitä»£æ›¿ (TimeUnit.SECONDS.sleep(1))</p>
</blockquote>
<h5 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt()"></a>interrupt()</h5><blockquote>
<p>ä¸­æ–­çº¿ç¨‹ï¼Œè°è°ƒè°è¢«æ‰“æ–­ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ (InterruptedException)</p>
<ol>
<li>å¹¶ä¸èƒ½è¢«æ‰“æ–­ï¼Œéœ€è¦é…åˆæ‰“æ–­è¡¨è®°</li>
</ol>
</blockquote>
<h5 id="yield"><a href="#yield" class="headerlink" title="yield()"></a>yield()</h5><blockquote>
<p>è®©å‡ºcpuçš„ä½¿ç”¨æƒ</p>
<p>ä¸ä¸€å®šèƒ½æˆåŠŸï¼Œå› ä¸ºå³ä¾¿è®©å‡ºäº†ï¼Œä»»åŠ¡è°ƒåº¦å™¨ä¹Ÿæœ‰å¯èƒ½å†æ¬¡æ‰§è¡Œå½“å‰çº¿ç¨‹</p>
</blockquote>
<h5 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h5><blockquote>
<p>æ’é˜Ÿï¼Œç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè°è°ƒç”¨è°å°±ä¼šå…ˆæ‰§è¡Œç»“æŸ</p>
<p>å¤šä¸ªjoinçš„ç­‰å¾…æ—¶é—´æ˜¯æœ€å¤§é‚£ä¸ª</p>
<p>åº•å±‚æ˜¯wait</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    System.out.println(System.currentTimeMillis() - start); <span class="comment">// 2000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="wait"><a href="#wait" class="headerlink" title="wait()"></a>wait()</h5><h5 id="stop"><a href="#stop" class="headerlink" title="stop()"></a>stop()</h5><blockquote>
<p>ç›´æ¥åœæ­¢çº¿ç¨‹ï¼Œä¼šé‡Šæ”¾èµ„æºå’Œé”</p>
<ol>
<li>å¦‚æœç›´æ¥stopï¼Œä¼šé‡Šæ”¾èµ„æºï¼Œä½†æ˜¯ä¸å®‰å…¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå¹¶ä¸ä¼šæ‰§è¡Œå®Œæ¯•ï¼Œæœ€ç»ˆå¯¼è‡´æ•°æ®ä¸ä¸€è‡´é—®é¢˜</li>
<li>ä¸æ­¤ç±»ä¼¼çš„è¿˜æœ‰ suspend()ã€resume()æ–¹æ³•</li>
</ol>
</blockquote>
<h5 id="isInterrupted"><a href="#isInterrupted" class="headerlink" title="isInterrupted()"></a>isInterrupted()</h5><blockquote>
<p>æŸ¥çœ‹æ˜¯å¦æ‰“æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</p>
<ol>
<li>å¦‚æœæ˜¯é˜»å¡çº¿ç¨‹ä¼šæ˜¯ false (å› ä¸ºå¼‚å¸¸ä¼šé‡ç½®æ‰“æ–­æ ‡è®°)</li>
<li>å¦‚æœæ˜¯æ­£å¸¸çš„ true</li>
</ol>
</blockquote>
<h5 id="interrupted"><a href="#interrupted" class="headerlink" title="interrupted()"></a>interrupted()</h5><blockquote>
<p>æŸ¥çœ‹æ˜¯å¦æ‰“æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œä½†æ˜¯ä¼šæ¸…é™¤æ ‡è®°</p>
</blockquote>
<h5 id="park"><a href="#park" class="headerlink" title="park()"></a>park()</h5><blockquote>
<p>LockSupport.park()ï¼Œé˜»å¡çº¿ç¨‹</p>
<p>åº•å±‚æ˜¯UnSafeç±»çš„parkæ–¹æ³•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;unpark&quot;</span>);</span><br><span class="line">        <span class="comment">//            log.debug(&quot;&#123;&#125;&quot;, Thread.currentThread().isInterrupted());</span></span><br><span class="line">        Thread.interrupted();</span><br><span class="line">        <span class="comment">// å¹¶ä¸ä¼šç»§ç»­é˜»å¡</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥parkæ˜¯æ ¹æ®æ‰“æ–­çŠ¶æ€æ¥åˆ¤å®šæ˜¯å¦ä¼šæ‰§è¡Œçš„</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ä½¿ç”¨ Thread.interrupted()æ¥æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œåˆ™å¯ä»¥è®©parkç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;park again&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="notify"><a href="#notify" class="headerlink" title="notify()"></a>notify()</h5><blockquote>
<p>åœ¨æ­£åœ¨waitSetä¸­ç­‰å¾…çš„çº¿ç¨‹æŒ‘é€‰ä¸€ä¸ªå”¤é†’</p>
</blockquote>
<h5 id="notifyAll"><a href="#notifyAll" class="headerlink" title="notifyAll()"></a>notifyAll()</h5><blockquote>
<p>å°†waitSetä¸­çš„ç­‰å¾…çš„æ‰€æœ‰çš„çº¿ç¨‹å”¤é†’</p>
</blockquote>
<h5 id="é˜²æ­¢cpuå ç”¨100"><a href="#é˜²æ­¢cpuå ç”¨100" class="headerlink" title="é˜²æ­¢cpuå ç”¨100%"></a>é˜²æ­¢cpuå ç”¨100%</h5><blockquote>
<ol>
<li>ä½¿ç”¨sleep</li>
<li>waitæˆ–æ¡ä»¶å˜é‡</li>
</ol>
<p>åä¸¤ç§éœ€è¦åŠ é”ï¼Œå¹¶ä¸”éœ€è¦ç›¸åº”çš„å”¤é†’æ“ä½œï¼Œä¸€èˆ¬é€‚ç”¨äºåŒæ­¥åœºæ™¯</p>
<p>sleepé€‚ç”¨äºæ— éœ€åŠ é”çš„åŒæ­¥åœºæ™¯</p>
</blockquote>
<h5 id="ä¸¤é˜¶æ®µåœæ­¢æ¨¡å¼"><a href="#ä¸¤é˜¶æ®µåœæ­¢æ¨¡å¼" class="headerlink" title="ä¸¤é˜¶æ®µåœæ­¢æ¨¡å¼"></a>ä¸¤é˜¶æ®µåœæ­¢æ¨¡å¼</h5><p>xxxxxxxxxxÂ RPMï¼ˆReadHat Package Managerï¼‰ â€‹rpm -qa æŸ¥è¯¢å·²å®‰è£…è½¯ä»¶rpm -qi è½¯ä»¶åç§°  æ˜¯å¦å·²ç»å®‰è£…æ­¤è½¯ä»¶rpm -e è½¯ä»¶åŒ… å¸è½½è½¯ä»¶rpm -e â€“nodeps è½¯ä»¶åŒ… å¸è½½è½¯ä»¶ï¼Œä¸è€ƒè™‘ä¾èµ–å…³ç³»â€‹rpm -ivh rpmåŒ…å å®‰è£…è½¯ä»¶-i install-v â€“verboseï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯-h â€“hash,è¿›åº¦æ¡â€“nodeps å®‰è£…å‰ä¸æ£€æŸ¥ä¾èµ–â€‹æ¨èyum install è½¯ä»¶åyum remove è½¯ä»¶åyum update å‡çº§è½¯ä»¶å‚æ•°â€”install å®‰è£… update æ›´æ–°check-update æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ›´æ–°remove ç§»é™¤list æ˜¾ç¤ºè½¯ä»¶åŒ…ä¿¡æ¯clean æ¸…ç†yumè¿‡æœŸçš„ç¼“å­˜deplist æ˜¾ç¤ºyumè½¯ä»¶åŒ…çš„æ‰€æœ‰ä¾èµ–å…³ç³»â€‹æ›´æ”¹è½¯ä»¶æ›´æ–°ä¸‹è½½é•œåƒæºğŸˆğŸˆğŸˆtodomarkdown</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;é€€å‡º&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;ç›‘æ§&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">// é‡ç½®æ ‡è®°</span></span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(<span class="number">4000</span>);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹"><a href="#ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹"></a>ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</h5><blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaè¿›ç¨‹éœ€è¦æ‰€æœ‰çº¿ç¨‹ç»“æŸåæ‰ä¼šç»ˆæ­¢ç¨‹åºï¼Œæœ‰ä¸€ç§ç‰¹æ®Šçº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶ä»–éå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</p>
</blockquote>
<h3 id="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</h3><blockquote>
<ol>
<li>æ–°å»ºã€å‡†å¤‡ã€è¿è¡Œã€é˜»å¡ã€ç»ˆç»“</li>
<li>æ–°å»ºã€è¿è¡Œã€å¸¦æ—¶ç­‰å¾…ã€ç­‰å¾…ã€é”å®šã€ç»ˆç»“ (Javaä¸­çš„)</li>
</ol>
</blockquote>
<h5 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">// NEW</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) ;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">// RUNNABLE</span></span><br><span class="line">        <span class="keyword">synchronized</span> (LifeState.class) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">// TIMED_WAITING</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">// WAITING</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread3.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">// BLOCKED</span></span><br><span class="line">        <span class="keyword">synchronized</span> (LifeState.class) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; <span class="comment">// TERMINATED</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    thread2.start();</span><br><span class="line">    thread3.start();</span><br><span class="line">    thread4.start();</span><br><span class="line">    thread5.start();</span><br><span class="line">    thread6.start();</span><br><span class="line"></span><br><span class="line">    System.out.println(thread1.getState());</span><br><span class="line">    System.out.println(thread2.getState());</span><br><span class="line">    System.out.println(thread3.getState());</span><br><span class="line">    System.out.println(thread4.getState());</span><br><span class="line">    System.out.println(thread5.getState());</span><br><span class="line">    System.out.println(thread6.getState());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å…±äº«æ¨¡å‹ç®¡ç†"><a href="#å…±äº«æ¨¡å‹ç®¡ç†" class="headerlink" title="å…±äº«æ¨¡å‹ç®¡ç†"></a>å…±äº«æ¨¡å‹ç®¡ç†</h3><h5 id="å…±äº«é—®é¢˜"><a href="#å…±äº«é—®é¢˜" class="headerlink" title="å…±äº«é—®é¢˜"></a>å…±äº«é—®é¢˜</h5><blockquote>
<p>i++å¹¶éåŸå­æ“ä½œï¼Œå®ƒä¼šè¢«åˆ†ä¸º3æ¡æŒ‡ä»¤: </p>
<ol>
<li>è·å–iå€¼</li>
<li>è¿›è¡Œè‡ªå¢æˆ–è‡ªå‡</li>
<li>å¯¹iè¿›è¡Œèµ‹å€¼</li>
</ol>
</blockquote>
<h5 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h5><blockquote>
<p> å¯¹ä»£è¿›è¡ŒåŠ é”</p>
<ul>
<li>public void static synchronized a(){}; æ­¤æ—¶é”ä½çš„æ˜¯ç±»å¯¹è±¡</li>
<li>public void synchronized a(){}; æ­¤æ—¶é”ä½çš„æ˜¯thiså¯¹è±¡</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            counter++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            counter--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(counter); <span class="comment">// æœ€ç»ˆcounterçš„å€¼å¹¶ä¸ä¸€å®šæ˜¯ 0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ThreadSecurity.class) &#123; <span class="comment">// åŠ ä¸Š synchronized é”</span></span><br><span class="line">                counter++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ThreadSecurity.class) &#123; <span class="comment">// åŠ ä¸Š synchronized é”</span></span><br><span class="line">                counter--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(counter); -- counter æ¯æ¬¡å€¼éƒ½ä¸º <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="çº¿ç¨‹å®‰å…¨åˆ†æ"><a href="#çº¿ç¨‹å®‰å…¨åˆ†æ" class="headerlink" title="çº¿ç¨‹å®‰å…¨åˆ†æ"></a>çº¿ç¨‹å®‰å…¨åˆ†æ</h5><h6 id="æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦å®‰å…¨"><a href="#æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦å®‰å…¨" class="headerlink" title="æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦å®‰å…¨"></a>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦å®‰å…¨</h6><blockquote>
<p>å¦‚æœå…±äº«äº†å¹¶ä¸”æœ‰å†™æ“ä½œå°±ä¸å®‰å…¨</p>
</blockquote>
<h6 id="å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨"><a href="#å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨" class="headerlink" title="å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨"></a>å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨</h6><blockquote>
<p>å±€éƒ¨å˜é‡æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å±€éƒ¨å¼•ç”¨å˜é‡ä¸ä¸€å®šæ˜¯å®‰å…¨çš„</p>
</blockquote>
<h6 id="å¸¸è§å®‰å…¨ç±»"><a href="#å¸¸è§å®‰å…¨ç±»" class="headerlink" title="å¸¸è§å®‰å…¨ç±»"></a>å¸¸è§å®‰å…¨ç±»</h6><blockquote>
<p>String(å…¶ä¸­å­˜å‚¨å­—ç¬¦çš„Stringçš„æ˜¯ä¸ªcharæ•°ç»„, å¹¶ä¸”å…¶ä¸­çš„æ‰€æœ‰ä¿®æ”¹æ–¹æ³•éƒ½æ˜¯ä¼šå†new ä¸€ä¸ªString)</p>
<p>è¿˜æœ‰ä¸€äº›StringBufferã€Hashtableã€ä»¥åŠä¸€äº›åŒ…è£…ç±»(Integerã€Doubleâ€¦)</p>
</blockquote>
<h6 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h6><blockquote>
<p>è´­ç¥¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Ticket</span> <span class="variable">ticket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Ticket</span>();</span><br><span class="line">        <span class="type">ThreadLocalRandom</span> <span class="variable">random</span> <span class="operator">=</span> ThreadLocalRandom.current();</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; ret = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> ticket.buyTicket(random.nextInt(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">                ret.add(res);</span><br><span class="line">            &#125;);</span><br><span class="line">            list.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> ret.stream().mapToInt(i -&gt; i).sum();</span><br><span class="line">        System.out.println(ticket.count);</span><br><span class="line">        System.out.println(sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ticket</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">buyTicket</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.count &gt;= num) &#123;</span><br><span class="line">            <span class="built_in">this</span>.count -= num;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;	</span><br></pre></td></tr></table></figure>

<p>è½¬è´¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PracticeTransfer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Account</span> <span class="variable">account1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">        <span class="type">Account</span> <span class="variable">account2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Account</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                account1.transfer(account2, <span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                account2.transfer(account1, <span class="number">500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(account1);</span><br><span class="line">        System.out.println(account2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">balance</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Account target, <span class="type">int</span> money)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Account.class) &#123; <span class="comment">// å¤šä¸ªAccount, å¹¶ä¸æ˜¯åªæœ‰thisä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.balance &gt; money) &#123;</span><br><span class="line">                target.balance += money;</span><br><span class="line">                <span class="built_in">this</span>.balance -= money;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Account&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;balance=&quot;</span> + balance +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h5><h6 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h6><blockquote>
<p>Monitor(ç›‘è§†å™¨), æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨synchronizedç»™å¯¹è±¡ä¸Šé”(é‡é‡çº§) ä¹‹åï¼Œè¯¥å¯¹è±¡çš„Mark Wordå°±è¢«è®¾ç½®æŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆ</p>
</blockquote>
<h6 id="Javaå¯¹è±¡å¤´"><a href="#Javaå¯¹è±¡å¤´" class="headerlink" title="Javaå¯¹è±¡å¤´"></a>Javaå¯¹è±¡å¤´</h6><blockquote>
<p>Javaå¯¹è±¡ç”±ä¸¤éƒ¨åˆ†ç»„æˆ: å¯¹è±¡å¤´ + å¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡</p>
<p>æ™®é€šå¯¹è±¡</p>
<table>
    <thead  align="center">
        <tr>
            <th colspan="2" align="center">Object Header (64 bits)</th>
        </tr>
    </thead>
   <tbody  align="center">
       <tr>
            <td>Mark Word(32 bits)</td>
            <td>Klass Word(32 bits)</td>
        </tr>
    </tbody>
</table>

<p>æ•°ç»„å¯¹è±¡</p>
<table>
    <thead align="center">
        <tr>
            <th colspan="3" align="center">Object Header (96 bits)</th>
        </tr>
    </thead>
   <tbody align="center">
       <tr>
            <td>Mark Word(32 bits)</td>
            <td>Klass Word(32 bits)</td>
            <td>array length(32 bits)</td>
        </tr>
    </tbody>
</table>

<p>Mark Wordç»“æ„</p>
<table>
    <thead  align="center">
        <tr>
            <th align="center">Mark Word (32 bits)</th>
            <th align="center">State</th>
        </tr>
    </thead>
   <tbody  align="center">
        <tr>
         <td>hashcode:25		age:4		biased_lock:0		01</td>
         <td>Normal</td>
        </tr>
       <tr>
             <td>thread:23		epoch:2		age:4		biased_lock:1		01</td>
          <td>Biased</td>
       </tr>
       <tr>
             <td>ptr_to_lock_record:30		00</td>
          <td>Lightweight Locked</td>
       </tr>
       <tr>
             <td>ptr_to_heavyweight_monitor:30		10</td>
          <td>Heavyweight Locked</td>
       </tr>
       <tr>
             <td>11</td>
          <td>Marked for GC</td>
       </tr>
    </tbody>
</table>
</blockquote>
<h5 id="synchronized-åŸç†"><a href="#synchronized-åŸç†" class="headerlink" title="synchronized åŸç†"></a>synchronized åŸç†</h5><blockquote>
<p>åŠ é”åŸç†ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¢«synchronizedçš„æ–¹æ³•æˆ–è€…å—æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹çš„MarkWordä¼šæŒ‡å‘ä¸€ä¸ªMonitorï¼Œè¿™ä¸ªMonitoråªèƒ½åŒæ—¶è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œå‡å¦‚ç°åœ¨æœ‰å…¶ä»–çº¿ç¨‹è®¿é—®çš„è¯ï¼Œä¼šè¢«åŠ å…¥åˆ°Monitorä¸­çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“æ­£åœ¨è®¿é—®çš„çº¿ç¨‹æ‰§è¡Œå®Œå, å¯¹MarkWordè¿›è¡Œé‡ç½®ï¼Œå”¤é†’EntryListï¼Œæ‰ç”±ç­‰å¾…ä¸­çš„çº¿ç¨‹æ¥ç«äº‰è®¿é—®ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230805125317400.png" alt="image-20230805125317400"></p>
</blockquote>
<h6 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h6><blockquote>
<p>å¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LightweightLock</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            test2();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªçº¿ç¨‹æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•ï¼Œè¿™ä¸ªé”è®°å½•å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„Mark Wordï¼Œå…¶ä¸­çš„Object reference ä¼šæŒ‡å‘é”å¯¹è±¡ï¼Œçº¿ç¨‹ä¼šå°è¯•ä½¿ç”¨casæ›¿æ¢é”å¯¹è±¡çš„Mark Wordï¼Œå°†Mark Wordå­˜å‚¨åˆ°è‡ªå·±çš„é”è®°å½•ä¸­ã€‚å°†è‡ªå·±çš„é”è®°å½•ä¸­çš„é”è®°å½•åœ°å€å’ŒçŠ¶æ€ç»™é”å¯¹è±¡å­˜å‚¨ã€‚</p>
<p>å¦‚æœcaså¤±è´¥äº†ï¼š</p>
<ol>
<li>è¢«å…¶ä»–çº¿ç¨‹å æœ‰äº†ï¼Œè¿›å…¥é”è†¨èƒ€</li>
<li>è‡ªå·±å æœ‰ï¼Œç»§ç»­åœ¨æ ˆå¸§ä¸­æ·»åŠ é”è®°å½•ï¼Œä½†æ˜¯é”è®°å½•ä¸­çš„é”è®°å½•çš„åœ°å€å’ŒçŠ¶æ€ä¸ºnull</li>
</ol>
<p>æœ€åå½“é€€å‡ºsynchronizedè§£é”æ—¶ï¼Œå¦‚æœé”è®°å½•ä¸ºnullï¼Œè¡¨ç¤ºä¸ºé‡å…¥é”ï¼Œå¹¶ä¸”é”è®°å½•å‡1</p>
<p>å…¶ä¸­è§£é”å¯èƒ½å¤±è´¥ä¹Ÿå¯èƒ½æˆåŠŸ:</p>
<ol>
<li>æˆåŠŸï¼Œè¡¨ç¤ºè§£é”æˆåŠŸ</li>
<li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›å…¥äº†é”è†¨èƒ€ï¼Œå·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806005904485.png" alt="image-20230806005904485"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806010811940.png" alt="image-20230806010811940"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806010837425.png" alt="image-20230806010837425"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806010859270.png" alt="image-20230806010859270"></p>
</blockquote>
<h6 id="é”è†¨èƒ€"><a href="#é”è†¨èƒ€" class="headerlink" title="é”è†¨èƒ€"></a>é”è†¨èƒ€</h6><blockquote>
<p>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿›æ¥éœ€è¦è·å¾—é”æ—¶ï¼Œå‘ç°é”è¢«å æœ‰ï¼Œäºæ˜¯é”å¯¹è±¡å°†ç”³è¯·Monitoré”ï¼Œè®©é”å¯¹è±¡æŒ‡å‘Monitorï¼Œç„¶åå°†è¿›æ¥çš„çº¿ç¨‹æ”¾å…¥åˆ°EntryListä¸­å¼€å§‹ç­‰å¾…ï¼Œå½“æ­£å æœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®Œåï¼Œé‡Šæ”¾é”åï¼Œå°†å”¤é†’æ­£åœ¨EntryListä¸­çš„çº¿ç¨‹ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806014819177.png" alt="image-20230806014819177"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806014841542.png" alt="image-20230806014841542"></p>
</blockquote>
<h6 id="è‡ªæ—‹ä¼˜åŒ–"><a href="#è‡ªæ—‹ä¼˜åŒ–" class="headerlink" title="è‡ªæ—‹ä¼˜åŒ–"></a>è‡ªæ—‹ä¼˜åŒ–</h6><blockquote>
<p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹ï¼ˆé€šè¿‡å¾ªç¯å‡ æ¬¡è·å–é”ï¼ŒJava6ä»¥åè‡ªé€‚åº”ï¼Œæ— æ³•è‡ªå·±æ§åˆ¶ï¼‰æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰è¿™æ—¶å€™çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</p>
<p>è‡ªæ—‹æˆåŠŸ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806101635454.png" alt="image-20230806101635454"></p>
<p>è‡ªæ—‹å¤±è´¥</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806101850382.png" alt="image-20230806101850382"></p>
</blockquote>
<h6 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h6><blockquote>
<p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰çš„æ—¶å€™ï¼Œæ¯æ¬¡é‡å…¥ä»éœ€è¦æ‰§è¡Œcasæ“ä½œ</p>
<p>Java6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨caså°†çº¿ç¨‹IDè®¾ç½®æˆåˆ°å¯¹è±¡çš„Mark Wordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹IDæ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–°casï¼Œä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å¯¹è±¡å°±å±äºè¯¥çº¿ç¨‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p>
<ol>
<li>å…¶ä¸­å¦‚æœè°ƒç”¨äº†å¯¹è±¡çš„hashCode()ï¼Œä¼šå¯¼è‡´åå‘é”è¢«æ’¤é”€ã€‚æ­¤æ—¶å‡çº§ä¸ºè½»é‡çº§é”</li>
<li>æœ‰å…¶ä»–çº¿ç¨‹æ¥è®¿é—®ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œå‡çº§ä¸ºè½»é‡çº§</li>
<li>è°ƒç”¨wait()&#x2F;notify()ï¼Œå‡çº§ä¸ºé‡é‡çº§ï¼Œå› ä¸ºæ­¤æ–¹æ³•æ˜¯é‡é‡çº§æ‰æœ‰çš„</li>
<li>å½“ 2 ä¸­çš„å…¶ä»–çº¿ç¨‹é¢‘ç¹æ¥è®¿é—®æ’¤é”€åå‘é”è¶…è¿‡20æ¬¡ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ›¿æ¢åå‘é” ï¼ˆæ‰¹é‡é‡åå‘ï¼‰</li>
<li>å½“æ’¤é”€æ¬¡æ•°è¶…è¿‡40æ¬¡åï¼Œä¼šè®©è¿™ä¸ªç±»çš„å¯¹è±¡å’Œæ–°å»ºçš„å¯¹è±¡ç¼–ç¨‹ä¸å¯åå‘çš„ï¼ˆæ‰¹é‡æ’¤é”€ï¼‰</li>
</ol>
</blockquote>
<h6 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h6><blockquote>
<p>Javaè¿è¡Œæ—¶ï¼ŒJIT å³æ—¶ç¼–è¯‘å™¨ä¼šå¯¹çƒ­ç‚¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¹é”è¿›è¡Œæ¶ˆé™¤</p>
</blockquote>
<h5 id="wait-x2F-notify"><a href="#wait-x2F-notify" class="headerlink" title="wait&#x2F;notify"></a>wait&#x2F;notify</h5><blockquote>
<p>å¤„ç†ç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«æ”¾åˆ°Monitorä¸­çš„waitSetä¸­ï¼Œæ­¤æ—¶éœ€è¦å¤„äºOwnerçš„çº¿ç¨‹notifyæˆ–è€…notifyAllæ¥å”¤é†’ï¼Œå”¤é†’åå°†ä¼šè¢«æ”¾å…¥åˆ°EntrySetä¸­è¿›è¡Œä¸‹æ¬¡çº¿ç¨‹çš„ç«äº‰</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230805125317400.png" alt="image-20230805125317400"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WaitThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (i) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    i.wait();</span><br><span class="line">                    System.out.println(<span class="string">&quot;wake up&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (i) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                i.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="wait-å’Œ-sleep-çš„åŒºåˆ«"><a href="#wait-å’Œ-sleep-çš„åŒºåˆ«" class="headerlink" title="wait å’Œ sleep çš„åŒºåˆ«"></a>wait å’Œ sleep çš„åŒºåˆ«</h6><blockquote>
<ol>
<li><p>sleep æ˜¯Threadçš„æ–¹æ³•ï¼Œwaitæ˜¯Objectçš„</p>
</li>
<li><p>sleepä¸éœ€è¦å’Œsynchronizedé…åˆä½¿ç”¨ï¼Œwaitéœ€è¦</p>
</li>
<li><p>sleepä½¿æ—¶ä¸ä¼šé‡Šæ”¾é”ï¼Œwait ä¼š</p>
<p>ä¸‹æ–¹ä»£ç ï¼Œå¦‚æœç”¨çš„Thread.sleepçš„è¯å°±ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹éƒ½å¾—ç­‰å¾…å¥¹sleepå®Œï¼Œæ‰èƒ½è·å¾—é”ï¼Œæ¢æˆwaitå°±èƒ½è§£å†³ã€‚å½“ç„¶interruptä¹Ÿèƒ½è§£å†³</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PracticeWaitNotify</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                                                                                                                           </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡&#123;&#125;&quot;</span>, hasCigarette);</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸä¼‘æ¯..&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¨œ&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">                                                                                                                           </span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">              <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                  log.debug(<span class="string">&quot;å¼€å§‹å¹²æ´»&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;å…¶ä»–äºº&quot;</span>).start();</span><br><span class="line">        &#125;</span><br><span class="line">                                                                                                                           </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;çƒŸåˆ°äº†!&quot;</span>);</span><br><span class="line">                hasCigarette = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°çº¢&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<h6 id="è™šå‡å”¤é†’"><a href="#è™šå‡å”¤é†’" class="headerlink" title="è™šå‡å”¤é†’"></a>è™šå‡å”¤é†’</h6><blockquote>
<p>å¦‚æœå¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ï¼Œæ­¤æ—¶ä½¿ç”¨notifyæ¥å”¤é†’waitçš„çº¿ç¨‹ï¼Œå°±å¯èƒ½ä¼šå”¤é†’ä¸æ˜¯è‡ªå·±æƒ³è¦çš„çº¿ç¨‹ã€‚</p>
<p>å¯ä»¥ç”¨notifyAll+while æ¥å¤„ç†ï¼Œwhileå¯ä»¥é˜²æ­¢è¢«ä¸å¿…è¦çš„å”¤é†’</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¾…å”¤é†’çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">synchronized</span>(locak) &#123;</span><br><span class="line">    <span class="keyword">while</span>(æ¡ä»¶ä¸æˆç«‹) &#123;</span><br><span class="line">        locak.wait();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">    lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="è®¾è®¡æ¨¡å¼-ä¿æŠ¤æ€§æš‚åœ"><a href="#è®¾è®¡æ¨¡å¼-ä¿æŠ¤æ€§æš‚åœ" class="headerlink" title="è®¾è®¡æ¨¡å¼-ä¿æŠ¤æ€§æš‚åœ"></a>è®¾è®¡æ¨¡å¼-ä¿æŠ¤æ€§æš‚åœ</h5><blockquote>
<p>Guarded Supension, ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ç»“æœ</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230806220116514.png" alt="image-20230806220116514"></p>
<p>é€šè¿‡while + wait + notifyAll æ¥åˆ¶ä½œä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æ—¶ä¼šé‡Šæ”¾é”ï¼Œå¹¶ä¸”å¯è¶…æ—¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuardendObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Guardend</span> <span class="variable">guardend</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Guardend</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;get start&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">ret</span> <span class="operator">=</span> guardend.get(<span class="number">2000</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, ret);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;get-thread&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;set start&quot;</span>);</span><br><span class="line">            guardend.set(<span class="string">&quot;666&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;set_thread&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Guardend</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// ç›´æ¥è¶…æ—¶æ•ˆæœ</span></span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// delay å‰©ä½™æ—¶é—´</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> timeout - now;</span><br><span class="line">                <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                lock.wait(delay);</span><br><span class="line">                now = System.currentTimeMillis() - base;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰©å±•ï¼Œå¤šä¸ªç±»ä¹‹é—´ä½¿ç”¨Guardendå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ–¹ä¾¿ï¼Œå¯ä½¿ç”¨ä¸‹å›¾æ¥è®¾è®¡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807021057445.png" alt="image-20230807021057445"></p>
</blockquote>
<h5 id="è®¾è®¡æ¨¡å¼-ç”Ÿäº§è€…-x2F-æ¶ˆè´¹è€…"><a href="#è®¾è®¡æ¨¡å¼-ç”Ÿäº§è€…-x2F-æ¶ˆè´¹è€…" class="headerlink" title="è®¾è®¡æ¨¡å¼-ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…"></a>è®¾è®¡æ¨¡å¼-ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…</h5><blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807112649932.png" alt="image-20230807112649932"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductorAndConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">messageQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueue</span>();</span><br><span class="line">        <span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    messageQueue.put(<span class="string">&quot;æ·»åŠ å€¼ä¸º: &quot;</span> + val);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">&quot;productor-&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹è€…</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                messageQueue.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;consumer&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageQueue</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> LinkedList&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (queue.isEmpty()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;é˜Ÿåˆ—ä¸ºç©º&quot;</span>);</span><br><span class="line">                    queue.wait();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> queue.removeFirst();</span><br><span class="line">                log.debug(<span class="string">&quot;è·å¾— &#123;&#125;&quot;</span>, ret);</span><br><span class="line">                queue.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String val)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">            <span class="keyword">while</span> (queue.size() == <span class="number">2</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;é˜Ÿåˆ—å·²æ»¡&quot;</span>);</span><br><span class="line">                queue.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            queue.add(Thread.currentThread().getName());</span><br><span class="line">            queue.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="çº¿ç¨‹çŠ¶æ€è½¬æ¢"><a href="#çº¿ç¨‹çŠ¶æ€è½¬æ¢" class="headerlink" title="çº¿ç¨‹çŠ¶æ€è½¬æ¢"></a>çº¿ç¨‹çŠ¶æ€è½¬æ¢</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807144953142.png" alt="image-20230807144953142"></p>
<blockquote>
<ol>
<li>NEW -&gt; RUNNABLE</li>
<li>RUNNABLE &lt;â€“&gt; WAITING</li>
<li>RUNNABLE &lt;â€“&gt; TIMED_WAITING</li>
<li>RUNNABLE &lt;â€“&gt; BLOCKED</li>
<li>RUNNABLE &lt;â€“&gt; TERMINATED</li>
</ol>
</blockquote>
<h5 id="æ´»è·ƒæ€§"><a href="#æ´»è·ƒæ€§" class="headerlink" title="æ´»è·ƒæ€§"></a>æ´»è·ƒæ€§</h5><h6 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h6><blockquote>
<p>ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å–å¤šæŠŠæ‰€</p>
<p>t1æƒ³è·å–aå¯¹è±¡çš„é”ï¼Œç„¶ååˆæƒ³è·å–bå¯¹è±¡çš„é” (åœ¨è·å–aå¯¹è±¡é”å’Œbå¯¹è±¡é”ä¹‹é—´ï¼ŒåŠ å…¥ä¸€ç‚¹å»¶æ—¶ï¼Œ100%æ­»é”)</p>
<p>t2æƒ³è·å–bå¯¹è±¡çš„é”ï¼Œç„¶ååˆæƒ³è·å–aå¯¹è±¡çš„é”</p>
</blockquote>
<h6 id="å®šä½æ­»é”"><a href="#å®šä½æ­»é”" class="headerlink" title="å®šä½æ­»é”"></a>å®šä½æ­»é”</h6><blockquote>
<p>jconsoleå¯ä»¥æˆ–è€…jpså®šä½çº¿ç¨‹id</p>
</blockquote>
<h6 id="å“²å­¦å®¶å°±é¤é—®é¢˜"><a href="#å“²å­¦å®¶å°±é¤é—®é¢˜" class="headerlink" title="å“²å­¦å®¶å°±é¤é—®é¢˜"></a>å“²å­¦å®¶å°±é¤é—®é¢˜</h6><blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807205046083.png" alt="image-20230807205046083"></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šæ­»é”</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;2å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;3å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;4å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5å·ç­·å­&quot;</span>);</span><br><span class="line">        List&lt;Philosopher&gt; philosopherList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;å­”å­&quot;</span>, c3, c4));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c4, c5));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;å‹’å¥ˆÂ·ç¬›å¡å°”&quot;</span>, c5, c1));</span><br><span class="line"></span><br><span class="line">        philosopherList.stream().forEach((item) -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                eat(item);</span><br><span class="line">            &#125;, item.getName()).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">(Philosopher philosopher)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (philosopher.getLeft()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (philosopher.getRight()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125; æ­£åœ¨åƒ&quot;</span>, philosopher.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Chopstick <span class="title function_">getLeft</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Chopstick <span class="title function_">getRight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯è§£å†³æ­»é”é—®é¢˜</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;2å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;3å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;4å·ç­·å­&quot;</span>);</span><br><span class="line">        <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5å·ç­·å­&quot;</span>);</span><br><span class="line">        List&lt;Philosopher&gt; philosopherList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;å­”å­&quot;</span>, c3, c4));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c4, c5));</span><br><span class="line">        philosopherList.add(<span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;å‹’å¥ˆÂ·ç¬›å¡å°”&quot;</span>, c5, c1));</span><br><span class="line"></span><br><span class="line">        philosopherList.stream().forEach((item) -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                eat(item);</span><br><span class="line">            &#125;, item.getName()).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">(Philosopher philosopher)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (philosopher.getLeft().tryLock()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (philosopher.getRight().tryLock()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125; æ­£åœ¨åƒ&quot;</span>, philosopher.getName());</span><br><span class="line">                    philosopher.getRight().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">                philosopher.getLeft().unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Chopstick <span class="title function_">getLeft</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Chopstick <span class="title function_">getRight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.left = left;</span><br><span class="line">        <span class="built_in">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807235025476.png" alt="image-20230807235025476"></p>
<h6 id="æ´»é”"><a href="#æ´»é”" class="headerlink" title="æ´»é”"></a>æ´»é”</h6><blockquote>
<p>ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹è±¡ç»“æœçš„æ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸ</p>
<p>é€šè¿‡æ”¹å˜æ‰§è¡Œæ—¶é—´ï¼Œå¯ä»¥è§£å†³ï¼Œä¾‹å¦‚Thread.sleepçš„æ—¶é—´æ”¹ä¸ºéšæœºçš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliveLock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line">                i--;</span><br><span class="line">                log.debug(<span class="string">&quot;i = &#123;&#125;&quot;</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line">                i++;</span><br><span class="line">                log.debug(<span class="string">&quot;i = &#123;&#125;&quot;</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h6 id="é¥¥é¥¿"><a href="#é¥¥é¥¿" class="headerlink" title="é¥¥é¥¿"></a>é¥¥é¥¿</h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807211437305.png" alt="image-20230807211437305"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807211446589.png" alt="image-20230807211446589"></p>
<h5 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h5><h5 id="Park-amp-Unpark"><a href="#Park-amp-Unpark" class="headerlink" title="Park&amp;Unpark"></a>Park&amp;Unpark</h5><blockquote>
<p>LockSupportç±»ä¸­çš„æ–¹æ³•ï¼Œå®åˆ™è°ƒç”¨çš„Unsafeç±»çš„parkå’ŒUnparkæ–¹æ³•</p>
<p>wait&amp;notify åŒºåˆ«</p>
<ul>
<li><p>waitã€notifyAllå’Œnotifyéœ€è¦é…åˆMonitorä¸€èµ·ä½¿ç”¨, è€Œparkã€unparkä¸éœ€è¦</p>
</li>
<li><p>park &amp; unparkæ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥æŒ‡å®š é˜»å¡å’Œå”¤é†’çš„ï¼Œnotifyæ˜¯éšæœºä¸€ä¸ªï¼ŒnotifyAllåˆ™æ˜¯æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œæ‰€ä»¥park &amp; unpark æ˜¯å¾ˆç²¾ç¡®çš„</p>
</li>
<li><p>park &amp; unpark å¯ä»¥å…ˆ unparkï¼Œè€Œwait &amp; notify åˆ™ä¸å¯ä»¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    ThreadUtil.sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    log.debug(<span class="string">&quot;unpark&quot;</span>);</span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<h6 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h6><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„Parkerå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç”±_mutexã€_counterã€_cond ç»„æˆ</p>
<blockquote>
<h5 id="è°ƒç”¨park"><a href="#è°ƒç”¨park" class="headerlink" title="è°ƒç”¨park"></a>è°ƒç”¨park</h5><ol>
<li>å½“è°ƒç”¨Unsafe.park()æ—¶</li>
<li>æ£€æŸ¥_counter, è¿™æ—¶è·å¾—_mutexäº’æ–¥é”</li>
<li>çº¿ç¨‹è¿›å…¥_condæ¡ä»¶é˜»å¡</li>
<li>è®¾ç½®_counter &#x3D; 0</li>
</ol>
<h5 id="è°ƒç”¨unpark"><a href="#è°ƒç”¨unpark" class="headerlink" title="è°ƒç”¨unpark"></a>è°ƒç”¨unpark</h5><ol>
<li>å½“è°ƒç”¨Unsafe.unparkæ—¶</li>
<li>è®¾ç½®_counter &#x3D; 1</li>
<li>çº¿ç¨‹å†æ¬¡è°ƒç”¨unparkï¼Œæ—¶å‘ç°_counter &#x3D; 1ï¼Œè®©çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä¸åœ¨é˜»å¡</li>
<li>è®¾ç½®_counter &#x3D; 0</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807125443077.png" alt="image-20230807125443077"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230807144234204.png" alt="image-20230807144234204"></p>
</blockquote>
<h5 id="å¤šæŠŠé”"><a href="#å¤šæŠŠé”" class="headerlink" title="å¤šæŠŠé”"></a>å¤šæŠŠé”</h5><blockquote>
<p>å¤šæŠŠä¸ç›¸å¹²çš„é”</p>
<ul>
<li>å¥½å¤„ï¼Œå¯ä»¥å¢å¼ºå¹¶å‘åº¦</li>
<li>åå¤„ï¼Œå¯èƒ½ä¼šæ­»é”ï¼Œå¦‚æœåŒæ—¶è·å–ä¸¤æŠŠé”</li>
</ul>
</blockquote>
<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><blockquote>
<p>å¯é‡å…¥é”</p>
<ol>
<li>å¯ä¸­æ–­</li>
<li>å¯è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li>å¯è®¾ç½®ä¸ºå…¬å¹³é”ï¼ˆä¼šé™ä½å¹¶å‘åº¦ï¼‰</li>
<li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</li>
</ol>
</blockquote>
<h5 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230814114509244.png" alt="image-20230814114509244"></p>
<h6 id="åŠ é”-NonfairSync"><a href="#åŠ é”-NonfairSync" class="headerlink" title="åŠ é”-NonfairSync"></a>åŠ é”-NonfairSync</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ä¸º NonfairSync</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) <span class="comment">// å¦‚æœ cas stateOffsetå±æ€§</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread()); <span class="comment">// ï¼Œå¦‚æœæˆåŠŸï¼Œè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºowner</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>); <span class="comment">// </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSetState</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="comment">// See below for intrinsics setup to support this</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, expect, update); <span class="comment">// æ­¤å¤„çš„ stateOffset æ˜¯ stateå¯¹è±¡å†…å­˜åç§»ä½ç½®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;  <span class="comment">// å°è¯•å†æ¬¡CAS</span></span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) <span class="comment">// é‡è¯•å¤±è´¥åï¼Œæ–°å¢ä¸€ä¸ªNodeåŠ å…¥åˆ°</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123; <span class="comment">// å¦‚æœå½“å‰node çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ headèŠ‚ç‚¹çš„è¯ï¼Œé‚£ä¹ˆå†æ¬¡å»è·å–é”ï¼›å¹¶ä¸”åé¢å”¤é†’å½“å‰çº¿ç¨‹éœ€è¦å‰ä¸€ä¸ªçº¿ç¨‹æ¥å”¤é†’</span></span><br><span class="line">                setHead(node); <span class="comment">// è®¾ç½®node ä¸ºå¤´ç»“ç‚¹</span></span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; <span class="comment">// æ£€æŸ¥å¹¶æ›´æ–°èŠ‚ç‚¹çŠ¶æ€,å¦‚æœpçš„waitStatus == -1,åˆ™ç›´æ¥è¿”å›trueï¼Œå¦‚æœ&gt;0ï¼Œåˆ™è·³è¿‡ï¼Œ&lt;0ï¼Œåˆ™è®¾ç½®waitStatus = -1</span></span><br><span class="line">                parkAndCheckInterrupt()) <span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="é‡Šæ”¾-NonfairSync"><a href="#é‡Šæ”¾-NonfairSync" class="headerlink" title="é‡Šæ”¾-NonfairSync"></a>é‡Šæ”¾-NonfairSync</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123; <span class="comment">// å°è¯•é‡Šæ”¾</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; </span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h); <span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c); <span class="comment">// é‡ç½® state</span></span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">         * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">         * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">         * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">         * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">         * non-cancelled successor.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next; <span class="comment">// headçš„next</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread); <span class="comment">// è¿™é‡Œé‡Šæ”¾äº†headçš„ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼ŒacquireQueued æ–¹æ³•ä¸­çš„çº¿ç¨‹ headçš„nextçº¿ç¨‹ä¼šå»ç«äº‰ï¼Œå¦‚æœæœ‰æ–°çº¿ç¨‹åŠ å…¥çš„è¯ã€‚æ²¡æœ‰å°±casæˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="å¯é‡å…¥-NonfairSync"><a href="#å¯é‡å…¥-NonfairSync" class="headerlink" title="å¯é‡å…¥-NonfairSync"></a>å¯é‡å…¥-NonfairSync</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”é‡å…¥</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123; <span class="comment">// é”é‡å…¥ï¼Œå¯¹state++</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”é‡Šæ”¾</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases; <span class="comment">// å¯¹state--ï¼Œç›´åˆ°state == 0,é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="ä¸å¯æ‰“æ–­"><a href="#ä¸å¯æ‰“æ–­" class="headerlink" title="ä¸å¯æ‰“æ–­"></a>ä¸å¯æ‰“æ–­</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸å¯æ‰“æ–­ï¼Œå¦‚æœçº¿ç¨‹åœ¨AQSé˜Ÿåˆ—ä¸­ï¼Œåˆ™ä¸å¯ä»¥æ‰“æ–­ï¼Œç›´åˆ°çº¿ç¨‹è·å¾—é”åæ‰èƒ½å†æ¬¡æ‰“æ–­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt(); <span class="comment">// æ‰“æ–­è‡ªå·±</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted; <span class="comment">// è·å–é”åï¼Œè¿”å›æ‰“æ–­æ ‡è®°</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt()) </span><br><span class="line">                interrupted = <span class="literal">true</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted(); <span class="comment">// è¿”å›æ‰“æ–­æ ‡è®°ï¼Œå¹¶ä¸”é‡ç½®æ ‡è®°ä¸ºfalseï¼Œè¿™æ ·å°±å¯¼è‡´ä¸Šé¢ä¸‹ä¸€æ¬¡è¿˜èƒ½parkä½</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="å¯æ‰“æ–­"><a href="#å¯æ‰“æ–­" class="headerlink" title="å¯æ‰“æ–­"></a>å¯æ‰“æ–­</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯æ‰“æ–­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«æ‰“æ–­äº†ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´forå¾ªç¯ç»“æŸ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>(); <span class="comment">// ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h6><p>å…¬å¹³é”æ˜¯é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ä¸åˆšè¿›æ¥çš„çº¿ç¨‹è¿›è¡Œç«äº‰ï¼Œæ‰€ä»¥è¯´æ˜¯å…¬å¹³çš„ï¼Œå°±ç®—ä½ çš„å‰é©±èŠ‚ç‚¹å”¤é†’äº†ä½ ï¼Œæ­¤æ—¶æœ‰æ–°çš„çº¿ç¨‹è¿›å…¥å¼€å§‹CASï¼Œå¦‚æœè¢«æ–°çš„çº¿ç¨‹æŠ¢å…ˆäº†ï¼Œè¿˜æ˜¯å¾—ç»§ç»­park</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) <span class="comment">// ç›´æ¥è¿›æ¥å°±å¼€å§‹ç«äº‰</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="ä¸å…¬å¹³é”"><a href="#ä¸å…¬å¹³é”" class="headerlink" title="ä¸å…¬å¹³é”"></a>ä¸å…¬å¹³é”</h6><p>ä¸å…¬å¹³åˆ™æ˜¯ä¼šå»åˆ¤å®šé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰ç½®èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¯ä»¥CAS, å®ƒä¼šä¼˜å…ˆè®©é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œç„¶åæ‰å»è·å¾—é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; <span class="comment">// æŸ¥çœ‹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰ç„¶åå†å»CAS</span></span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// The correctness of this depends on head being initialized</span></span><br><span class="line">    <span class="comment">// before tail and on head.next being accurate if the current</span></span><br><span class="line">    <span class="comment">// thread is first in queue.</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; <span class="comment">// Read fields in reverse initialization order</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp; <span class="comment">// head æ˜¯å¦ç­‰äº tailï¼Œå¦‚æœç­‰äºè¡¨ç¤ºé˜Ÿåˆ—ä¸­æ— çº¿ç¨‹ ç›´æ¥false</span></span><br><span class="line">        ((s = h.next) == <span class="literal">null</span> || <span class="comment">// å¹¶ä¸”å¦‚æœä¸ç­‰äºï¼Œè€Œä¸”ç¬¬äºŒä¸ªèŠ‚ç‚¹ç­‰äºnull</span></span><br><span class="line">         s.thread != Thread.currentThread()); <span class="comment">// æˆ–è€…å½“å‰çº¿ç¨‹ä¸ç­‰äºsçº¿ç¨‹ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="æ¡ä»¶å˜é‡-await"><a href="#æ¡ä»¶å˜é‡-await" class="headerlink" title="æ¡ä»¶å˜é‡-await"></a>æ¡ä»¶å˜é‡-await</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">nanosTimeout</span> <span class="operator">=</span> unit.toNanos(time);</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter(); <span class="comment">// æ·»åŠ nodeåˆ° ConditionObject</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node); <span class="comment">// æ¸…ç©ºstatusï¼Œå¹¶ä¸”å”¤é†’headçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”é‡Šæ”¾é”</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) <span class="comment">// acquireQueued() å°è¯•å»è·å¾—é”ï¼Œè·å¾—ä¸äº†park, å¯¹åº”ä¸‹é¢signal unpark</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();  <span class="comment">// å»æ‰ waitStatus != Node.CONDITION çš„èŠ‚ç‚¹</span></span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION); <span class="comment">// æ–°å»ºNodeï¼Œå½“å‰çº¿ç¨‹ï¼Œæ”¾åˆ° ConditionObject çš„ firstWaiter ä¸Š æˆ–è€… lastWaiter ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="æ¡ä»¶å˜é‡-signal"><a href="#æ¡ä»¶å˜é‡-signal" class="headerlink" title="æ¡ä»¶å˜é‡-signal"></a>æ¡ä»¶å˜é‡-signal</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively()) <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯owner(é”æŒæœ‰è€…)ï¼Œæœ‰é”æ‰èƒ½æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123; </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="literal">null</span>)</span><br><span class="line">            lastWaiter = <span class="literal">null</span>;</span><br><span class="line">        first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp; <span class="comment">// å¯¹waitçš„èŠ‚ç‚¹è¿›è¡Œè½¬ç§»,å°†è½¬ç§»åˆ°aqsé˜Ÿåˆ—å°¾éƒ¨ï¼Œè½¬ç§»è¿‡ç¨‹ä¸­å¯èƒ½ä¼šunparkå½“å‰node</span></span><br><span class="line">             (first = firstWaiter) != <span class="literal">null</span>);<span class="comment">// æˆ–è€…ç­‰åˆ° first == null</span></span><br><span class="line">&#125;					</span><br><span class="line">				<span class="comment">// doSignalAll waité˜Ÿåˆ—éå†å®Œ</span></span><br><span class="line"></span><br><span class="line">                  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">                      lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">                      <span class="keyword">do</span> &#123;</span><br><span class="line">                          <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">                          first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">                          transferForSignal(first);</span><br><span class="line">                          first = next;</span><br><span class="line">                      &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If cannot change waitStatus, the node has been cancelled.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Splice onto queue and try to set waitStatus of predecessor to</span></span><br><span class="line"><span class="comment">         * indicate that thread is (probably) waiting. If cancelled or</span></span><br><span class="line"><span class="comment">         * attempt to set waitStatus fails, wake up to resync (in which</span></span><br><span class="line"><span class="comment">         * case the waitStatus can be transiently and harmlessly wrong).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node); <span class="comment">// å°†æŠŠnodeåŠ å…¥åˆ°aqsé˜Ÿåˆ—çš„tail,å¹¶ä¸”è¿”å›tail</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL)) <span class="comment">// å¦‚æœpçš„waitStatus &gt; 0 æˆ–è€… å°†pçš„waitStatusä¿®æ”¹æˆ Node.SIGNAL ä»»æ„ä¸€ä¸ªæˆåŠŸï¼Œè¿™unparkè¿™ä¸ªnode</span></span><br><span class="line">        LockSupport.unpark(node.thread); <span class="comment">// è¿™é‡Œunparkæ˜¯ä¸ºäº†å¤„ç† pèŠ‚ç‚¹çš„waitStatus &gt; 0 æˆ–è€…æ— æ³•CASæˆåŠŸæˆ-1ï¼Œunparkäº¤ç»™ä¸Šé¢forå¾ªç¯å»å¤„ç†çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="â€”â€”â€”â€”â€”â€”â€”â€”â€“"><a href="#â€”â€”â€”â€”â€”â€”â€”â€”â€“" class="headerlink" title="â€”â€”â€”â€”â€”â€”â€”â€”â€“"></a>â€”â€”â€”â€”â€”â€”â€”â€”â€“</h5><h5 id="å¯é‡å…¥"><a href="#å¯é‡å…¥" class="headerlink" title="å¯é‡å…¥"></a>å¯é‡å…¥</h5><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    reenter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reenter</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    log.debug(<span class="string">&quot;lock 1&quot;</span>);</span><br><span class="line">    reenterSec();</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">reenterSec</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    log.debug(<span class="string">&quot;lock 2&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="å¯ä¸­æ–­"><a href="#å¯ä¸­æ–­" class="headerlink" title="å¯ä¸­æ–­"></a>å¯ä¸­æ–­</h5><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lockInterruptibly();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è¢«ä¸­æ–­&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    lock.lock();</span><br><span class="line">    thread.start();</span><br><span class="line">    ThreadUtil.sleep(<span class="number">1000</span>);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="å¯è®¾ç½®è¶…æ—¶æ—¶é—´"><a href="#å¯è®¾ç½®è¶…æ—¶æ—¶é—´" class="headerlink" title="å¯è®¾ç½®è¶…æ—¶æ—¶é—´"></a>å¯è®¾ç½®è¶…æ—¶æ—¶é—´</h5><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!lock.tryLock(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è¶…æ—¶&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.debug(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    lock.lock();</span><br><span class="line">    ThreadUtil.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="å¯è®¾ç½®å…¬å¹³é”"><a href="#å¯è®¾ç½®å…¬å¹³é”" class="headerlink" title="å¯è®¾ç½®å…¬å¹³é”"></a>å¯è®¾ç½®å…¬å¹³é”</h5><blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡"><a href="#æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡" class="headerlink" title="æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡"></a>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</h5><blockquote>
<p>å¯æŒ‡å®šå”¤é†’ waitçš„çº¿ç¨‹</p>
<p>ä½¿ç”¨æµç¨‹</p>
<ol>
<li>await å‰éœ€è¦é”</li>
<li>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥confitionObjectç­‰å¾…</li>
<li>await çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€è¶…æ—¶ï¼‰é‡æ–°ç«äº‰locké”</li>
<li>ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;condition&quot;</span>).start();</span><br><span class="line">    ThreadUtil.sleep(<span class="number">1000</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;å”¤é†’ condition&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    condition.signalAll();</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h3><blockquote>
<p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨è¯»å†™é”è®©è¯»-è¯»å¯ä»¥å¹¶å‘ï¼Œä»è€Œæé«˜æ€§èƒ½</p>
<p>è¯»-è¯» ä¸äº’æ–¥ï¼›è¯»-å†™ äº’æ–¥; å†™-å†™ äº’æ–¥ï¼› æ•…æœ‰å†™å³äº’æ–¥</p>
<p>ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„selectâ€¦fromâ€¦lock in share mode</p>
</blockquote>
<h5 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ—¶è·å¾—åˆ°è¯»é”çš„</span></span><br><span class="line"><span class="type">ReentrantReadWriteLock</span> <span class="variable">reentrantReadWriteLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">readLock</span> <span class="operator">=</span> reentrantReadWriteLock.readLock();</span><br><span class="line">ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">writeLock</span> <span class="operator">=</span> reentrantReadWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;thread-1&quot;</span>);</span><br><span class="line">        ThreadUtil.sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        log.debug(<span class="string">&quot;thread-2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line"><span class="number">20</span>:<span class="number">22</span>:<span class="number">15.807</span> lock.ReentrantReadWriteLockTest [Thread-<span class="number">0</span>] - thread-<span class="number">1</span></span><br><span class="line"><span class="number">20</span>:<span class="number">22</span>:<span class="number">15.807</span> lock.ReentrantReadWriteLockTest [Thread-<span class="number">1</span>] - thread-<span class="number">2</span></span><br></pre></td></tr></table></figure>

<h5 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h5><blockquote>
<ol>
<li>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</li>
<li>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å¾—å†™é”ï¼Œä¼šå¯¼è‡´å†™é”æ°¸ä¹…ç­‰å¾…ï¼ˆä¸èƒ½ç”¨è¯»é”å»åµŒå¥—å†™é”ï¼Œä½†æ˜¯å¯ä»¥å…ˆè·å–è¯»é”ï¼Œè·å–æ•°æ®å†å»é‡Šæ”¾è¯»é”ï¼Œç„¶åå†å»è·å–å†™é”ï¼Œä¿®æ”¹æ•°æ®ï¼Œå†å»é™çº§æˆè¯»é”è·å–è¯»é”ï¼Œå†é‡Šæ”¾å†™é”ï¼Œé‡Šæ”¾è¯»é”ï¼›å³è·å–å’Œé‡Šæ”¾2æ¬¡è¯»é”ï¼Œè·å–å’Œé‡Šæ”¾1æ¬¡å†™é”ï¼‰</li>
<li>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</li>
</ol>
</blockquote>
<h5 id="äº‹é¡¹2-å®˜æ–¹è§£å†³ä¾‹å­"><a href="#äº‹é¡¹2-å®˜æ–¹è§£å†³ä¾‹å­" class="headerlink" title="äº‹é¡¹2-å®˜æ–¹è§£å†³ä¾‹å­"></a>äº‹é¡¹2-å®˜æ–¹è§£å†³ä¾‹å­</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230816204204754.png" alt="image-20230816204204754"></p>
<h5 id="è¯»å†™é”åº”ç”¨"><a href="#è¯»å†™é”åº”ç”¨" class="headerlink" title="è¯»å†™é”åº”ç”¨"></a>è¯»å†™é”åº”ç”¨</h5><h6 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h6><blockquote>
<p>æ­¤ç±»JDK8åŠ å…¥ï¼ŒStampedLockæ”¯æŒ tryOptimisticRead() æ–¹æ³•(ä¹è§‚è¯») ï¼Œ è¯»å–å®Œæ¯•åéœ€è¦ä¸€æ¬¡æˆ³æ ¡éªŒï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦åˆ™éœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®å®‰å…¨</p>
<p>å¯ç”¨ä½œç¼“å­˜ï¼Œå¤šè¯»å°‘å†™</p>
</blockquote>
<h5 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h5><blockquote>
<p>æµç¨‹ä¸ ReentrantLock ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å†™é”çŠ¶æ€å äº†stateçš„ä½16ä½ï¼Œè¯»é”çŠ¶æ€å äº†é«˜16ä¸º</p>
</blockquote>
<h6 id="åŠ é”-å†™"><a href="#åŠ é”-å†™" class="headerlink" title="åŠ é”-å†™"></a>åŠ é”-å†™</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) <span class="comment">// acquireQueuedã€addWaiterä¸ReentrantLockä¸€è‡´</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123; <span class="comment">// acquires = 1</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c); <span class="comment">// è·å–å†™é”çŠ¶æ€ï¼Œæ˜¯è¿˜æ²¡è¢«å ç”¨è¿˜æ˜¯å·²ç»å ç”¨äº† 0 æˆ–è€… &gt; 0</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread()) <span class="comment">// å†™é”ä¸º 0ï¼Œä½†æ˜¯ status ä¸ä¸º0ï¼Œè¯´æ˜æœ‰è¯»é”ä½†æ˜¯æƒ³å‡çº§æˆå†™é”(è¯»é”ä¸èƒ½å‡çº§å†™é”); ç¬¬äºŒç§è¡¨ç¤ºé”é‡å…¥ï¼Œéownerçº¿ç¨‹ä¸è®©é”é‡å…¥ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½ç›´æ¥è¿”å›falseï¼Œåé¢ç›´æ¥è®©è¿›å…¥aqsé˜Ÿåˆ—ã€‚</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT) <span class="comment">// é”é‡å…¥æ¬¡æ•°è¶…è¿‡ä¸€å®šä¸Šçº¿ï¼Œç›´æ¥æŠ›é”™è¯¯(ä¸å¤ªå¯èƒ½ï¼Œé‡å…¥è¿™ä¹ˆæ·±çš„é”)</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// Reentrant acquire</span></span><br><span class="line">        setState(c + acquires); <span class="comment">// å†™é” + 1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// c == 0 çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() || <span class="comment">// å†™æ˜¯å¦è¯¥å µå¡</span></span><br><span class="line">        !compareAndSetState(c, c + acquires)) <span class="comment">// ä¿®æ”¹å†™é”çŠ¶æ€, å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹å…ˆåˆ°æ•…æœ‰casä¸æˆåŠŸçš„æƒ…å†µ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    setExclusiveOwnerThread(current); <span class="comment">// è®¾ç½® owner</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="åŠ é”-è¯»"><a href="#åŠ é”-è¯»" class="headerlink" title="åŠ é”-è¯»"></a>åŠ é”-è¯»</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123; <span class="comment">// arg = 1</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>) <span class="comment">// æˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›-1</span></span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°è¯•è·å–å…±äº«è¯»é”</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; <span class="comment">// ç‹¬å é”çŠ¶æ€(å†™é”)ä¸ä¸º0ï¼›è¿™é‡Œåœ¨åˆ¤å®šå†™é”é™çº§ä¸ºè¯»é”</span></span><br><span class="line">        getExclusiveOwnerThread() != current) <span class="comment">// </span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c); <span class="comment">// è¯»é”çŠ¶æ€å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp; <span class="comment">// è¯»æ˜¯å¦è¯¥å µå¡</span></span><br><span class="line">        r &lt; MAX_COUNT &amp;&amp; <span class="comment">// è¯»é”å¤§å° å°äº 65535</span></span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123; <span class="comment">// å¢é‡è¯»é”çŠ¶æ€(è¯»é”çŠ¶æ€ + 1)</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123; <span class="comment">// è¯»é”çŠ¶æ€ç­‰äº 0 </span></span><br><span class="line">            firstReader = current; <span class="comment">// ç¬¬ä¸€ä¸ªè¯»èŠ‚ç‚¹</span></span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>; </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">// æ¶‰åŠåˆ°ThreadLocal</span></span><br><span class="line">            <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);<span class="comment">// æœªcasæˆåŠŸ, é‡Œé¢è¿˜ä¼šå†æ¬¡å»casï¼Œä»¥åŠå¯¹çº¿ç¨‹è®¡æ•°å™¨çš„å¤„ç†,å…¶ä¸­æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±æœ¬åœ°çš„çº¿ç¨‹è®¡æ•°å™¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;<span class="comment">// é€»è¾‘ä¸ ReentrantLock ç±»ä¼¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED); <span class="comment">// SHAREDç±»å‹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r);<span class="comment">// è®¾ç½®å¤´ç»“ç‚¹ï¼Œå¹¶ä¸”é‡Šæ”¾ä¸€è¿ä¸²SharedèŠ‚ç‚¹(è¿™å°±æ˜¯ä¸ºä»€ä¹ˆèƒ½è¯»å¹¶å‘çš„åŸå› )</span></span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        selfInterrupt();<span class="comment">// ä¼šå°†è‡ªå·±ä¸­æ–­æ‰</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; <span class="comment">// Record old head for check below</span></span><br><span class="line">        setHead(node); <span class="comment">// è®¾ç½®node ä¸º head</span></span><br><span class="line">        <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">            (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">                doReleaseShared();<span class="comment">// é‡Šæ”¾SharedèŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h6 id="é‡Šæ”¾-å†™"><a href="#é‡Šæ”¾-å†™" class="headerlink" title="é‡Šæ”¾-å†™"></a>é‡Šæ”¾-å†™</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123; <span class="comment">// ç±»ä¼¼ RL</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="é‡Šæ”¾-è¯»"><a href="#é‡Šæ”¾-è¯»" class="headerlink" title="é‡Šæ”¾-è¯»"></a>é‡Šæ”¾-è¯»</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">  		....</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c - SHARED_UNIT; <span class="comment">// è¯»çŠ¶æ€ - 1</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// Releasing the read lock has no effect on readers,</span></span><br><span class="line">            <span class="comment">// but it may allow waiting writers to proceed if</span></span><br><span class="line">            <span class="comment">// both read and write locks are now free.</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>; <span class="comment">// è¯»çŠ¶æ€ä¸º0ä¸ºtrueï¼Œå¦åˆ™false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="StampedLock-1"><a href="#StampedLock-1" class="headerlink" title="StampedLock"></a>StampedLock</h3><blockquote>
<p>éœ€è¦é…åˆæˆ³ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">lock.unlockWrite(stamp);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>StampedLockæ”¯æŒ tryOptimisticRead() æ–¹æ³•(ä¹è§‚è¯») ï¼Œ è¯»å–å®Œæ¯•åéœ€è¦ä¸€æ¬¡æˆ³æ ¡éªŒï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦åˆ™éœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®å®‰å…¨</li>
<li>ä½†æ˜¯ä¸æ”¯æŒå¯é‡å…¥ï¼Œ å’Œæ¡ä»¶å˜é‡</li>
<li>æ”¯æŒè¯»å†™é”ç›¸äº’è½¬æ¢</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line"><span class="comment">// æ ¡éªŒæˆ³</span></span><br><span class="line"><span class="keyword">if</span> (!lock.validate(stamp))&#123;</span><br><span class="line">    <span class="comment">// é”å‡çº§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StampedLockTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Test</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(test.getName(<span class="number">0</span>));</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(test.getName(<span class="number">10</span>));</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å†™æ•°æ®&quot;</span>);</span><br><span class="line">            test.setName(<span class="string">&quot;ac&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(test.getName(<span class="number">0</span>));</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">(<span class="type">long</span> sleepTime)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ans</span> <span class="operator">=</span> name;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line">        ThreadUtil.sleep(sleepTime);</span><br><span class="line">        <span class="keyword">if</span> (!lock.validate(stamp)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ•°æ®è¢«ä¿®æ”¹: &#123;&#125;&quot;</span>, stamp);</span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ans = name;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlockRead(stamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŸç†-2"><a href="#åŸç†-2" class="headerlink" title="åŸç†"></a>åŸç†</h5><blockquote>
<p>stateï¼š64ä½ï¼Œå‰7ä½è¡¨ç¤ºè¯»é”çŠ¶æ€ã€ç¬¬8ä½è¡¨ç¤ºå†™é”çŠ¶æ€ã€9-64ä½è¡¨ç¤ºstampçŠ¶æ€writeLock</p>
</blockquote>
<h6 id="writeLock"><a href="#writeLock" class="headerlink" title="writeLock()"></a>writeLock()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">writeLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> s, next;  <span class="comment">// bypass acquireWrite in fully unlocked case only</span></span><br><span class="line">    <span class="comment">// state é»˜è®¤ä¸º 256</span></span><br><span class="line">    <span class="comment">// s &amp;&amp; 255 è¡¨ç¤ºstateçš„ç¬¬8ä½æ˜¯å¦ä¸º 0</span></span><br><span class="line">    <span class="comment">// å¦‚æœä¸º0è¡¨ç¤ºæ— é”, è¿›è¡Œcas</span></span><br><span class="line">    <span class="comment">// å¦åˆ™è°ƒç”¨ acquireWrite</span></span><br><span class="line">    <span class="keyword">return</span> ((((s = state) &amp; ABITS) == <span class="number">0L</span> &amp;&amp;</span><br><span class="line">             U.compareAndSwapLong(<span class="built_in">this</span>, STATE, s, next = s + WBIT)) ?</span><br><span class="line">            next : acquireWrite(<span class="literal">false</span>, <span class="number">0L</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¶ä¸­ä¼šä¸¤æ¬¡æ­»å¾ªç¯ä¸¤æ¬¡</span></span><br><span class="line"><span class="comment">// è·å–é”ï¼Œå¦‚æœå¤±è´¥åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">acquireWrite</span><span class="params">(<span class="type">boolean</span> interruptible, <span class="type">long</span> deadline)</span> &#123;</span><br><span class="line">    <span class="type">WNode</span> <span class="variable">node</span> <span class="operator">=</span> <span class="literal">null</span>, p;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">spins</span> <span class="operator">=</span> -<span class="number">1</span>;;) &#123; <span class="comment">// spin while enqueuing</span></span><br><span class="line">        <span class="type">long</span> m, s, ns;</span><br><span class="line">        <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">        <span class="keyword">if</span> ((m = (s = state) &amp; ABITS) == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapLong(<span class="built_in">this</span>, STATE, s, ns = s + WBIT))</span><br><span class="line">                <span class="keyword">return</span> ns;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥ï¼Œå¯¹spins èµ‹å€¼ï¼Œç„¶åè¿›è¡Œè‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (spins &lt; <span class="number">0</span>)</span><br><span class="line">            spins = (m == WBIT &amp;&amp; wtail == whead) ? SPINS : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LockSupport.nextSecondarySeed() &gt;= <span class="number">0</span>)</span><br><span class="line">                --spins;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–å¯¹pè¿›è¡Œèµ‹å€¼wtailï¼Œå’Œåˆå§‹åŒ–whead</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((p = wtail) == <span class="literal">null</span>) &#123; <span class="comment">// initialize queue</span></span><br><span class="line">            <span class="type">WNode</span> <span class="variable">hd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WNode</span>(WMODE, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="built_in">this</span>, WHEAD, <span class="literal">null</span>, hd))</span><br><span class="line">                wtail = hd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä¸Šæ–¹çš„node</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">            node = <span class="keyword">new</span> <span class="title class_">WNode</span>(WMODE, p);</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰èŠ‚ç‚¹è¢«æ”¹å˜(å¯èƒ½é˜Ÿåˆ—è¢«å…¶ä»–çº¿ç¨‹åˆæ·»åŠ äº†node)ï¼Œé‡æ–°èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node.prev != p)</span><br><span class="line">            node.prev = p;</span><br><span class="line">        <span class="comment">// å°è¯•å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºé˜Ÿå°¾ï¼ŒæˆåŠŸå°±å°†ä¸Šä¸€æ¬¡é˜Ÿå°¾çš„ä¸‹ä¸€ä¸ªæ”¹æˆå½“å‰èŠ‚ç‚¹ï¼Œç„¶åbreaké€€å‡º</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapObject(<span class="built_in">this</span>, WTAIL, p, node)) &#123;</span><br><span class="line">            p.next = node;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">spins</span> <span class="operator">=</span> -<span class="number">1</span>;;) &#123;</span><br><span class="line">        WNode h, np, pp; <span class="type">int</span> ps;</span><br><span class="line">        <span class="comment">// å¤´èŠ‚ç‚¹ç­‰äºå°¾èŠ‚ç‚¹(æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹)ï¼Œå¯ä»¥å°è¯•å†æ¬¡è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">if</span> ((h = whead) == p) &#123;</span><br><span class="line">            <span class="keyword">if</span> (spins &lt; <span class="number">0</span>)</span><br><span class="line">                spins = HEAD_SPINS;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (spins &lt; MAX_HEAD_SPINS)</span><br><span class="line">                spins &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> spins;;) &#123; <span class="comment">// spin at head</span></span><br><span class="line">                <span class="type">long</span> s, ns;</span><br><span class="line">                <span class="keyword">if</span> (((s = state) &amp; ABITS) == <span class="number">0L</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapLong(<span class="built_in">this</span>, STATE, s,</span><br><span class="line">                                             ns = s + WBIT)) &#123;</span><br><span class="line">                        whead = node;</span><br><span class="line">                        node.prev = <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">return</span> ns;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (LockSupport.nextSecondarySeed() &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         --k &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¸®åŠ©é‡Šæ”¾cowaitä¸­çš„è¯»èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (h != <span class="literal">null</span>) &#123; <span class="comment">// help release stale waiters</span></span><br><span class="line">            WNode c; Thread w;</span><br><span class="line">            <span class="comment">// h.cowait != null, é‡Šæ”¾è¯»èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">while</span> ((c = h.cowait) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &amp;&amp;</span><br><span class="line">                    (w = c.thread) != <span class="literal">null</span>)</span><br><span class="line">                    U.unpark(w);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        	<span class="comment">// å¤´èŠ‚ç‚¹ä¸å˜çš„æƒ…å†µä¸‹</span></span><br><span class="line">            <span class="keyword">if</span> (whead == h) &#123;</span><br><span class="line">                <span class="comment">// nodeçš„prveæ”¹å˜äº†ï¼Œä¸ç­‰äºp</span></span><br><span class="line">                <span class="keyword">if</span> ((np = node.prev) != p) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (np != <span class="literal">null</span>)</span><br><span class="line">                        <span class="comment">// é‡ç½®på¹¶ä¸”å°†p.nextå†æ¬¡æŒ‡å‘node</span></span><br><span class="line">                        (p = np).next = node;   <span class="comment">// stale</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ä¿®æ”¹å‰é©±èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((ps = p.status) == <span class="number">0</span>)</span><br><span class="line">                    U.compareAndSwapInt(p, WSTATUS, <span class="number">0</span>, WAITING);</span><br><span class="line">                <span class="comment">// åˆ é™¤å‰é©±èŠ‚ç‚¹(å–æ¶ˆçš„)</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ps == CANCELLED) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((pp = p.prev) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        node.prev = pp;</span><br><span class="line">                        pp.next = node;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// è¶…æ—¶å–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">                    <span class="type">long</span> time; <span class="comment">// 0 argument to park means no timeout</span></span><br><span class="line">                    <span class="keyword">if</span> (deadline == <span class="number">0L</span>)</span><br><span class="line">                        time = <span class="number">0L</span>;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ((time = deadline - System.nanoTime()) &lt;= <span class="number">0L</span>)</span><br><span class="line">                        <span class="keyword">return</span> cancelWaiter(node, node, <span class="literal">false</span>);</span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                    U.putObject(wt, PARKBLOCKER, <span class="built_in">this</span>);</span><br><span class="line">                    node.thread = wt;</span><br><span class="line">                    <span class="keyword">if</span> (p.status &lt; <span class="number">0</span> &amp;&amp; (p != h || (state &amp; ABITS) != <span class="number">0L</span>) &amp;&amp;</span><br><span class="line">                        whead == h &amp;&amp; node.prev == p)</span><br><span class="line">                        U.park(<span class="literal">false</span>, time);  <span class="comment">// emulate LockSupport.park</span></span><br><span class="line">                    node.thread = <span class="literal">null</span>;</span><br><span class="line">                    U.putObject(wt, PARKBLOCKER, <span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (interruptible &amp;&amp; Thread.interrupted())</span><br><span class="line">                        <span class="keyword">return</span> cancelWaiter(node, node, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><blockquote>
<p>ä¿¡å·é‡ï¼Œç”¨æ¥é™åˆ¶åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™(åªé€‚åˆå•æœºçº¿ç¨‹æ•°)</p>
</blockquote>
<h5 id="ä½¿ç”¨-1"><a href="#ä½¿ç”¨-1" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    log.debug(<span class="string">&quot;runningã€‚ã€‚&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                    log.debug(<span class="string">&quot;release&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="é‡å†™è¿æ¥æ± "><a href="#é‡å†™è¿æ¥æ± " class="headerlink" title="é‡å†™è¿æ¥æ± "></a>é‡å†™è¿æ¥æ± </h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConnectionPool</span> <span class="variable">connectionPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionPool</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionPool.get();</span><br><span class="line">                log.debug(<span class="string">&quot;çº¿ç¨‹ &#123;&#125;, è·å–åˆ°äº† &#123;&#125;&quot;</span>, Thread.currentThread().getName(), connection.getName());</span><br><span class="line">                connectionPool.free(connection);</span><br><span class="line">            &#125;, <span class="string">&quot;therad-&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConnectionPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray locks;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Connection&gt; connections;</span><br><span class="line">    <span class="keyword">private</span> Semaphore semaphore;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> PoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectionPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PoolSize = poolSize;</span><br><span class="line">        <span class="built_in">this</span>.semaphore = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(poolSize);</span><br><span class="line">        <span class="built_in">this</span>.locks = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(PoolSize);</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(PoolSize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections.add(<span class="keyword">new</span> <span class="title class_">Connection</span>(UUID.randomUUID().toString().split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphore.acquire();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; PoolSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (locks.get(i) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        locks.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> connections.get(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¾ªç¯ä¸€æ¬¡éƒ½è¢«å ç”¨äº†</span></span><br><span class="line"><span class="comment">//            synchronized (this) &#123;</span></span><br><span class="line"><span class="comment">//                try &#123;</span></span><br><span class="line"><span class="comment">//                    log.debug(&quot;ç­‰å¾…ä¸­..&quot;);</span></span><br><span class="line"><span class="comment">//                    wait();</span></span><br><span class="line"><span class="comment">//                &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection coon)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; PoolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections.get(i) == coon) &#123;</span><br><span class="line">                locks.set(i, <span class="number">0</span>);</span><br><span class="line">                semaphore.release();</span><br><span class="line">                log.debug(<span class="string">&quot;é‡Šæ”¾ &#123;&#125;&quot;</span>, coon.getName());</span><br><span class="line"><span class="comment">//                synchronized (this) &#123;</span></span><br><span class="line"><span class="comment">//                    // é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">//                    this.notifyAll();</span></span><br><span class="line"><span class="comment">//                    log.debug(&quot;é‡Šæ”¾ &#123;&#125;&quot;, coon.getName());</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;é‡Šæ”¾å¤±è´¥, æœªæ‰¾åˆ°å¯¹åº”Connection&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Connection</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Connection</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŸç†-3"><a href="#åŸç†-3" class="headerlink" title="åŸç†"></a>åŸç†</h5><h6 id="åŠ é”-å…¬å¹³"><a href="#åŠ é”-å…¬å¹³" class="headerlink" title="åŠ é”-å…¬å¹³"></a>åŠ é”-å…¬å¹³</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>) <span class="comment">// å°äº0ï¼Œæ‰å¼€å§‹parkå…¶ä»–çº¿ç¨‹</span></span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nonfairTryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires;</span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> || <span class="comment">// çŠ¶æ€æœ€å¤šç­‰äº0å°±è¿”å›</span></span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r); <span class="comment">// é‡Šæ”¾ä¸€ç³»åˆ—shared Node</span></span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="é‡Šæ”¾-å…¬å¹³"><a href="#é‡Šæ”¾-å…¬å¹³" class="headerlink" title="é‡Šæ”¾-å…¬å¹³"></a>é‡Šæ”¾-å…¬å¹³</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();<span class="comment">// é‡Šæ”¾è€äºŒèŠ‚ç‚¹...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next)) <span class="comment">// ä¿®æ”¹çŠ¶æ€åˆ°åˆå§‹åŒ–é˜¶æ®µ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CountdownLatch"><a href="#CountdownLatch" class="headerlink" title="CountdownLatch"></a>CountdownLatch</h3><blockquote>
<p>ç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå€’è®¡æ—¶</p>
<p>å…¶ä¸­æ„é€ å‚æ•°ç”¨æ¥åˆå§‹åŒ–ç­‰å¾…è®¡æ•°å€¼ï¼Œawait()ç”¨æ¥ç­‰å¾…è®¡æ•°å½’é›¶ï¼ŒcountDownç”¨æ¥è®¡æ•°å‡ä¸€</p>
</blockquote>
<h5 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, finalI);</span><br><span class="line">            ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line">            countDownLatch.countDown(); </span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    countDownLatch.await(); <span class="comment">// ä¼šç­‰å¾… status å‡åˆ° 0, ç±»ä¼¼joinï¼Œä½†æ˜¯ä½¿ç”¨æ›´æ–¹ä¾¿(å¯é…åˆçº¿ç¨‹æ± ä½¿ç”¨)ï¼Œjoinæ›´åŠ åº•å±‚ï¼Œä½†æ˜¯ä½¿ç”¨æ›´åŠ ç¹ç</span></span><br><span class="line">    log.debug(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é…åˆçº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, finalI);</span><br><span class="line">            ThreadUtil.sleep(<span class="number">500</span>);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    log.debug(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŸç†-4"><a href="#åŸç†-4" class="headerlink" title="åŸç†"></a>åŸç†</h5><h6 id="countDown"><a href="#countDown" class="headerlink" title="countDown()"></a>countDown()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countDown</span><span class="params">()</span> &#123;</span><br><span class="line">	sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾è€äºŒèŠ‚ç‚¹</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">// Decrement count; signal when transition to zero</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–state</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¦‚æœ state == 0 ç›´æ¥è¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// state - 1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c-<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// cas stateå¦‚æœnextc == 0 åˆ™è¿”å›true</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="await"><a href="#await" class="headerlink" title="await()"></a>await()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>) <span class="comment">// å°è¯•è·å–ä¸€æ¬¡é”</span></span><br><span class="line">        doAcquireSharedInterruptibly(arg);<span class="comment">// è¿›å…¥é‡Œé¢ä¼šè®©å½“å‰çº¿ç¨‹park ä½ï¼Œæ‰€ä»¥éœ€è¦å½“state == 0 çš„æ—¶å€™ï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹ï¼Œè¿™æ ·å°±èƒ½å½¢æˆä¸€ç§è®¡æ•°çš„åŠŸèƒ½</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="comment">// status == 0 è¿”å› 1 å¦åˆ™ è¿”å› 0</span></span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><blockquote>
<p>å¯é‡å¤ä½¿ç”¨çš„ CountdownLatch</p>
</blockquote>
<h5 id="ç®€å•ä½¿ç”¨-1"><a href="#ç®€å•ä½¿ç”¨-1" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>); <span class="comment">// çº¿ç¨‹æ•°éœ€è¦å’Œä¸‹é¢ CyclicBarrieræ„é€ å™¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸€è‡´ï¼Œä¸ç„¶ä¼šä»»åŠ¡ä¸€è‡´ä¸å®Œæˆï¼Œæˆ–ä»»åŠ¡å®Œæˆå¯¹ä¸ä¸Š</span></span><br><span class="line">    <span class="type">CyclicBarrier</span> <span class="variable">cyclicBarrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>, ()-&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;finish&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> i;</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;çº¿ç¨‹: &#123;&#125;&quot;</span>, k);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                cyclicBarrier.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŸç†-5"><a href="#åŸç†-5" class="headerlink" title="åŸç†"></a>åŸç†</h5><h3 id="åŒæ­¥é¡ºåºæ§åˆ¶"><a href="#åŒæ­¥é¡ºåºæ§åˆ¶" class="headerlink" title="åŒæ­¥é¡ºåºæ§åˆ¶"></a>åŒæ­¥é¡ºåºæ§åˆ¶</h3><h5 id="wait-notifyç‰ˆæœ¬"><a href="#wait-notifyç‰ˆæœ¬" class="headerlink" title="wait notifyç‰ˆæœ¬"></a>wait notifyç‰ˆæœ¬</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.wait();</span><br><span class="line">                log.debug(<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">            lock.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="park-unpark-ç‰ˆæœ¬"><a href="#park-unpark-ç‰ˆæœ¬" class="headerlink" title="park unpark ç‰ˆæœ¬"></a>park unpark ç‰ˆæœ¬</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        log.debug(<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="await-signal-ç‰ˆæœ¬"><a href="#await-signal-ç‰ˆæœ¬" class="headerlink" title="await signal ç‰ˆæœ¬"></a>await signal ç‰ˆæœ¬</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">                log.debug(<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            condition.signal();</span><br><span class="line">            log.debug(<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="äº¤æ›¿è¾“å‡º"><a href="#äº¤æ›¿è¾“å‡º" class="headerlink" title="äº¤æ›¿è¾“å‡º"></a>äº¤æ›¿è¾“å‡º</h3><h5 id="wait-notifyç‰ˆæœ¬-1"><a href="#wait-notifyç‰ˆæœ¬-1" class="headerlink" title="wait notifyç‰ˆæœ¬"></a>wait notifyç‰ˆæœ¬</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">                    flag = !flag;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">                    flag = !flag;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="park-unpark-ç‰ˆæœ¬-1"><a href="#park-unpark-ç‰ˆæœ¬-1" class="headerlink" title="park unpark ç‰ˆæœ¬"></a>park unpark ç‰ˆæœ¬</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LockSupport.unpark(t2);</span><br><span class="line">        &#125;</span><br><span class="line">        flag++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="await-signal-ç‰ˆæœ¬-1"><a href="#await-signal-ç‰ˆæœ¬-1" class="headerlink" title="await signal ç‰ˆæœ¬"></a>await signal ç‰ˆæœ¬</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">c1</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"><span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">c2</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c2.signal();</span><br><span class="line">                    c1.await();</span><br><span class="line">                    log.debug(<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c1.signal();</span><br><span class="line">                    c2.await();</span><br><span class="line">                    log.debug(<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å…±äº«å†…å­˜æ¨¡å‹"><a href="#å…±äº«å†…å­˜æ¨¡å‹" class="headerlink" title="å…±äº«å†…å­˜æ¨¡å‹"></a>å…±äº«å†…å­˜æ¨¡å‹</h3><h5 id="Javaå†…å­˜æ¨¡å‹"><a href="#Javaå†…å­˜æ¨¡å‹" class="headerlink" title="Javaå†…å­˜æ¨¡å‹"></a>Javaå†…å­˜æ¨¡å‹</h5><blockquote>
<p>JMM å³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€CPUå¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPUæŒ‡ä»¤ä¼˜åŒ–ç­‰</p>
<p>JMMä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢</p>
<ul>
<li>åŸå­æ€§ - ä¿è¯æ‰§è¡Œä¸ä¼šå—åˆ°çº¿ç¨‹çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li>
<li>å¯è§æ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—cpuç¼“å­˜çš„å½±å“</li>
<li>æœ‰åºæ€§ - ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°cpuæ‰§è¡Œå¹¶è¡Œä¼˜åŒ–çš„å½±å“</li>
</ul>
<p>synchronized  å’Œ  volatile  <strong>éƒ½æ”¯æŒå¯è§æ€§ã€æœ‰æœ‰åºæ€§</strong>ï¼Œä½†æ˜¯synchronizedæ”¯æŒåŸå­æ€§ï¼Œvolatileä¸å¯ä»¥</p>
<p>synchronized æ˜¯èƒ½è§£å†³åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§ã€‚ä½†æ˜¯æœ‰åºæ€§å¿…é¡»ä»£ç éƒ½åœ¨synchronizedçš„ä¸´ç•ŒåŒºä¸­ï¼ˆæ¯æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå¹¶ä¸å½±å“æœ€ç»ˆç»“æœï¼‰ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸åœ¨è¿™ä¸ªä¸´ç•ŒåŒºå¤–çš„ä»£ç æ˜¯æœ‰å¯èƒ½äº§ç”Ÿæœ‰åºæ€§çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼Œå•ä¾‹æ¨¡å¼åŒæ£€é”ç§å¦‚æœä¸å¯¹éœ€è¦å•ä¾‹çš„å¯¹è±¡ä½¿ç”¨volatileå…³é”®å­—çš„è¯ï¼Œå°±ä¼šé€ æˆä¸€äº›çº¿ç¨‹æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæˆçš„å¯¹è±¡ã€‚</p>
</blockquote>
<h5 id="ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼-volatileç‰ˆ"><a href="#ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼-volatileç‰ˆ" class="headerlink" title="ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ volatileç‰ˆ"></a>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ volatileç‰ˆ</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isRun</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isRun) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;é€€å‡º&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;ç›‘æ§&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    isRun = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŒæ­¥æ¨¡å¼-Balking"><a href="#åŒæ­¥æ¨¡å¼-Balking" class="headerlink" title="åŒæ­¥æ¨¡å¼ Balking"></a>åŒæ­¥æ¨¡å¼ Balking</h5><blockquote>
<p>Balking (çŠ¹è±«)æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isOpen</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    start();</span><br><span class="line">    start();</span><br><span class="line">    ThreadUtil.sleep(<span class="number">3000</span>);</span><br><span class="line">    stop();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å·²å¼€å¯ç›‘æ§!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        isOpen = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (isOpen) &#123;</span><br><span class="line">            ThreadUtil.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;ç›‘æ§ä¸­ã€‚ã€‚ã€‚&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">    isOpen = <span class="literal">false</span>;</span><br><span class="line">    log.debug(<span class="string">&quot;å·²å…³é—­&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æŒ‡ä»¤é‡æ’åºä¼˜åŒ–"><a href="#æŒ‡ä»¤é‡æ’åºä¼˜åŒ–" class="headerlink" title="æŒ‡ä»¤é‡æ’åºä¼˜åŒ–"></a>æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</h5><p>ç°ä»£å¤„ç†å™¨ä¼šè¢«è®¾è®¡ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„cpuæŒ‡ä»¤ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼šå–æŒ‡ä»¤ - æŒ‡ä»¤ç¼–ç   - æ‰§è¡ŒæŒ‡ä»¤ - å†…å­˜è®¿é—® - æ•°æ®å†™å›ï¼›æœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†æ˜¯å®ƒèƒ½å˜ç›¸åœ°æé«˜äº†æŒ‡ä»¤åœ°ååç‡ï¼Œå…¶ä¸­ä¸²è¡Œçš„æ–¹å¼æ‰§è¡ŒæŒ‡ä»¤å¹¶ä¸èƒ½æŠŠç¼“å­˜ã€ALUéƒ½èƒ½ä½¿ç”¨èµ·æ¥ï¼Œåè€Œæ˜¯æ¯æ¬¡å°±è¿è¡Œå…¶ä¸­ä¸€ä¸ªï¼Œå¦‚æœä½¿ç”¨æµæ°´çº¿çš„æ–¹å¼ï¼Œåˆ™å°½å¯èƒ½å¾—å°†è¿™äº›éƒ½è¿ç”¨èµ·æ¥</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230809121912300.png" alt="image-20230809121912300"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230809122102877.png" alt="image-20230809122102877"></p>
<h5 id="volatile-åŸç†"><a href="#volatile-åŸç†" class="headerlink" title="volatile åŸç†"></a>volatile åŸç†</h5><blockquote>
<p>volatile åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœ</p>
</blockquote>
<h6 id="å†™å±éšœ"><a href="#å†™å±éšœ" class="headerlink" title="å†™å±éšœ"></a>å†™å±éšœ</h6><blockquote>
<p>å†™å±éšœä¿éšœåœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    read = <span class="literal">true</span>; <span class="comment">// read æ˜¯ volatile å†™å±éšœ,å¹¶ä¸”å¯é˜²æ­¢ä¹‹å‰çš„æŒ‡ä»¤é‡æ’</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</blockquote>
<h6 id="è¯»å±éšœ"><a href="#è¯»å±éšœ" class="headerlink" title="è¯»å±éšœ"></a>è¯»å±éšœ</h6><blockquote>
<p>è¯»å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å±éšœ</span></span><br><span class="line">   	<span class="comment">// read æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span><br><span class="line">    <span class="keyword">if</span> (read) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="double-check-locking-é—®é¢˜"><a href="#double-check-locking-é—®é¢˜" class="headerlink" title="double check locking é—®é¢˜"></a>double check locking é—®é¢˜</h5><blockquote>
<p>å…¸å‹ä¾‹å­ï¼šå•ä¾‹æ¨¡å¼ åŒæ£€ç´¢</p>
<p>ä¸‹æ–¹ Singleton å¦‚æœä¸åŠ  volatile çš„è¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´è·å¾—çš„æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæˆçš„å¯¹è±¡: singleton åŸæœ¬åº”è¯¥åœ¨ Singleton å¯¹è±¡åˆå§‹åŒ–åæ‰èƒ½è·å¾—å…¶åœ°å€ï¼Œä½†æ˜¯ç”±äºæŒ‡ä»¤é‡æ’ä¼šå°† è€—æ—¶çš„ åˆå§‹åŒ–å¯¹è±¡æ”¾åˆ° singleton è·å¾—åœ°å€ä¹‹åï¼Œä¹Ÿå°±æ˜¯ singleton å…ˆè·å¾—åœ°å€ï¼Œç„¶åæ‰å»åˆå§‹åŒ– Singletonï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æ–°æ¥ä¸€ä¸ªçº¿ç¨‹singleton &#x3D;&#x3D; null åˆ¤å®šå‘ç° singleton ä¸ç­‰äºnullï¼Œæ­¤æ—¶ç›´æ¥è¿”å› singletonï¼Œä½†æ˜¯æ­¤æ—¶è¿”å›çš„æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæˆçš„ Singletonå¯¹è±¡</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ååºåˆ—åŒ–ä¼šç ´åå•ä¾‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (singleton != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> singleton;</span><br><span class="line">            &#125;</span><br><span class="line">            singleton = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singleton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Singleton</span> <span class="variable">instance1</span> <span class="operator">=</span> Singleton.getInstance();</span><br><span class="line">    <span class="type">Singleton</span> <span class="variable">instance2</span> <span class="operator">=</span> Singleton.getInstance();</span><br><span class="line">    System.out.println(instance2 == instance1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜²æ­¢ååºåˆ—åŒ–</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å…±äº«æ¨¡å‹ä¹‹æ— é”"><a href="#å…±äº«æ¨¡å‹ä¹‹æ— é”" class="headerlink" title="å…±äº«æ¨¡å‹ä¹‹æ— é”"></a>å…±äº«æ¨¡å‹ä¹‹æ— é”</h3><h5 id="CASä¸volatile"><a href="#CASä¸volatile" class="headerlink" title="CASä¸volatile"></a>CASä¸volatile</h5><blockquote>
<p>CAS Compare And Swap æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œæ˜¯åŸå­çš„</p>
<p>å¹¶ä¸”æ— é”æ•ˆç‡æ˜¯å¾ˆé«˜çš„ï¼Œåœ¨å¤šæ ¸CPUå¹¶ä¸”çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡CPUæ ¸å¿ƒæ•°çš„æƒ…å†µä¸‹å¯å‘æŒ¥å…¶æ•ˆç‡ï¼Œå› ä¸ºsynchronized åŠ é”é‡Šæ”¾é”ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå‘ç”Ÿé˜»å¡ã€‚æ— é”åˆ™èƒ½ä¸€ç›´è¿è¡Œé‡è¯•å¤±è´¥ï¼Œæ²¡æœ‰é˜»å¡ï¼Œç›´åˆ°CASæˆåŠŸåé€€å‡ºçº¿ç¨‹ã€‚</p>
<p>CASæ¯”è¾ƒé€‚åˆå¤šè¯»å°‘å†™</p>
</blockquote>
<p>å…¶ä¸­ balance.compareAndSet(expect, update)æ–¹æ³•æ˜¯åŸå­æ€§çš„ï¼Œäºæ˜¯1000ä¸ªçº¿ç¨‹éƒ½é€šè¿‡whileå¾ªç¯æ¥è¿›è¡ŒCASï¼Œå¦‚æœå½“å‰çš„expectå€¼ä¸å½“å‰balanceå€¼ä¸€æ ·ï¼Œåˆ™ä¼šä¿®æ”¹ï¼Œå¦åˆ™ä¸€ç›´å¾ªç¯ç›´åˆ°ä¸è‡ªå·±çš„ä¸€æ ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">balance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">10000</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    List&lt;Thread&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            withdraw(<span class="number">10</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        list.add(thread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    list.forEach(Thread::start);</span><br><span class="line">    ThreadUtil.sleep(<span class="number">500</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, balance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">withdraw</span><span class="params">(<span class="type">int</span> money)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">expect</span> <span class="operator">=</span> balance.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> expect - money;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> balance.compareAndSet(expect, update);</span><br><span class="line">        <span class="keyword">if</span> (b)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŸå­æ•´æ•°"><a href="#åŸå­æ•´æ•°" class="headerlink" title="åŸå­æ•´æ•°"></a>åŸå­æ•´æ•°</h5><p>AtomicInteger åŸå­æ•´æ•°ï¼Œé€šè¿‡CASä¿è¯åŸå­æ€§ï¼Œç±»ä¼¼çš„è¿˜æœ‰AtomicBooleaã€AtomicLongâ€¦</p>
<ol>
<li>get è·å–æœ€æ–°å€¼</li>
<li>getAndSet è·å–å¹¶è®¾ç½®</li>
<li>compareAndSet æ¯”è¾ƒå¹¶æ›¿æ¢ï¼ŒåŸå­çš„</li>
<li>getAndUpdate ç»™äºˆè¡¨è¾¾å¼æ“ä½œ</li>
<li>â€¦</li>
</ol>
<h5 id="åŸå­å¼•ç”¨"><a href="#åŸå­å¼•ç”¨" class="headerlink" title="åŸå­å¼•ç”¨"></a>åŸå­å¼•ç”¨</h5><ol>
<li>AtomicReference</li>
<li>AtomicMarkableReference</li>
<li>AtomicStampedReference</li>
</ol>
<h5 id="ABAé—®é¢˜"><a href="#ABAé—®é¢˜" class="headerlink" title="ABAé—®é¢˜"></a>ABAé—®é¢˜</h5><blockquote>
<ol>
<li>æ¯”å¦‚æœ‰ä¸‰ä¸ªçº¿ç¨‹ï¼Œmainã€t1ã€t2ï¼Œå¦‚æœt1 å°† å˜é‡ temp &#x3D; A æ›´æ”¹ä¸ºäº† Bï¼Œçº¿ç¨‹t2åˆtempæ›´æ”¹ä¸ºäº† B -&gt; Aï¼Œæ­¤æ—¶mainçº¿ç¨‹ä¸­getåˆ°çš„æ•°æ®è¿˜æ˜¯Aï¼Œäºæ˜¯å°±å°†A-&gt;Cï¼Œå…¶ä¸­mainå¹¶ä¸èƒ½æ„ŸçŸ¥åˆ°tempæ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡</li>
<li>å¯é€šè¿‡æ·»åŠ ç‰ˆæœ¬å·è§£å†³ï¼Œå¦‚æœç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼Œåˆ™å·²ç»è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AtomicStampedReference å¯åˆ¤å®šæ›´æ”¹è¿‡çš„ç‰ˆæœ¬å·</span></span><br><span class="line">AtomicStampedReference&lt;String&gt; tem = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;String&gt;(<span class="string">&quot;A&quot;</span>, <span class="number">0</span>); <span class="comment">// æ·»åŠ ä¸€ä¸ªç‰ˆæœ¬å· Stamp</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    tem.compareAndSet(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;).start();</span><br><span class="line">ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    tem.compareAndSet(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;).start();</span><br><span class="line">ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line">tem.compareAndSet(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">log.debug(tem.getReference()); <span class="comment">// A</span></span><br><span class="line">log.debug(<span class="string">&quot;version: &#123;&#125;&quot;</span>, tem.getStamp()); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»…åˆ¤å®šæ˜¯å¦æ›´æ”¹è¿‡</span></span><br><span class="line">AtomicMarkableReference&lt;String&gt; tmp = <span class="keyword">new</span> <span class="title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="string">&quot;garbage&quot;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">    tmp.compareAndSet(<span class="string">&quot;garbage&quot;</span>, <span class="string">&quot;no garbage&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;).start();</span><br><span class="line">ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line">tmp.compareAndSet(<span class="string">&quot;garbage&quot;</span>, <span class="string">&quot;no garbage2&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">log.debug(tmp.getReference()); <span class="comment">// no garbage</span></span><br></pre></td></tr></table></figure>

<h5 id="åŸå­æ•°ç»„"><a href="#åŸå­æ•°ç»„" class="headerlink" title="åŸå­æ•°ç»„"></a>åŸå­æ•°ç»„</h5><p>Unsafeä¸­å¦‚æœæ“ä½œçš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123; <span class="comment">// é€šè¿‡å€¼åœ¨å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œæ¥è¿›è¡ŒCAS</span></span><br><span class="line">    <span class="keyword">return</span> compareAndSetRaw(checkedByteOffset(i), expect, update);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">checkedByteOffset</span><span class="params">(<span class="type">int</span> i)</span> &#123; <span class="comment">// è·å–å€¼çš„åç§»é‡</span></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= array.length)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;index &quot;</span> + i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> byteOffset(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>AtomicIntegerArray</li>
<li>AtomicLongArray</li>
<li>AtomicReferenceArray</li>
</ol>
</blockquote>
<h5 id="å­—æ®µæ›´æ–°å™¨"><a href="#å­—æ®µæ›´æ–°å™¨" class="headerlink" title="å­—æ®µæ›´æ–°å™¨"></a>å­—æ®µæ›´æ–°å™¨</h5><blockquote>
<ol>
<li>AtomicIntegerFieldUpdater</li>
<li>AtomicLongFieldUpdater</li>
<li>AtomicReferenceFieldUpdater</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicFiled</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">tperson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        tperson.name = <span class="string">&quot;jack&quot;</span>;</span><br><span class="line">        AtomicReferenceFieldUpdater&lt;Person, String&gt; person =</span><br><span class="line">                AtomicReferenceFieldUpdater.newUpdater(Person.class, String.class, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        person.compareAndSet(tperson, <span class="string">&quot;jack&quot;</span>, <span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        System.out.println(tperson);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åŸå­ç´¯åŠ å™¨"><a href="#åŸå­ç´¯åŠ å™¨" class="headerlink" title="åŸå­ç´¯åŠ å™¨"></a>åŸå­ç´¯åŠ å™¨</h5><p>Striped64 ç±»ä¸“é—¨æ•°å­—ç´¯åŠ å’Œè®¡ç®—çš„çš„ï¼Œå…¶ä¸­å®ç°ç±»æœ‰, å…¶ä¸­æ•ˆç‡æ˜¯å¾ˆé«˜çš„ã€‚</p>
<p>æ•ˆç‡é«˜ä¸»è¦åŸå› æ˜¯ï¼Œåœ¨CASæ—¶ï¼Œè®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒ,thread-0ç´¯åŠ cell[0],è€Œthread-1 ç´¯åŠ  cell[1]..æœ€åå°†ç»“æœæ±‡æ€»ã€‚å› æ­¤å¯å‡å°‘CASé‡è¯•å¤±è´¥</p>
<blockquote>
<p>â€‹      ç´¯åŠ â€”â€“</p>
<ol>
<li><p>LongAdder</p>
</li>
<li><p>DoubleAdder</p>
<p>è®¡ç®—â€”â€”</p>
</li>
<li><p>LongAccumulator</p>
</li>
<li><p>DoubleAccumulator</p>
</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LongAdder</span> <span class="variable">longAdder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LongAdder</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(longAdder::increment).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ThreadUtil.sleep(<span class="number">100</span>);</span><br><span class="line">System.out.println(longAdder.sum());</span><br></pre></td></tr></table></figure>

<h5 id="LongAdder-æºç "><a href="#LongAdder-æºç " class="headerlink" title="LongAdder æºç "></a>LongAdder æºç </h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123; <span class="comment">// Contendedé˜²æ­¢ç¼“å­˜è¡Œå…±äº«ï¼Œé˜²æ­¢ä¸€ä¸ªç¼“å­˜è¡Œå…±äº«å¤šä¸ªcellå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> value;</span><br><span class="line">    Cell(<span class="type">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">cas</span><span class="params">(<span class="type">long</span> cmp, <span class="type">long</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="built_in">this</span>, valueOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>CPUç¼“å­˜ï¼Œå…¶ä¸­ç¼“å­˜é€Ÿåº¦ä»ä¸Šå¾€ä¸‹L1ã€L2ã€L3ã€..åˆ°å†…å­˜ï¼Œå…¶ä¸­ç¼“å­˜å­˜å‚¨æ•°æ®çš„å•ä½æ˜¯ç¼“å­˜è¡Œï¼Œå¦‚æœæŸä¸ªcpuæ ¸å¿ƒä¿®æ”¹äº†æŸä¸ªç¼“å­˜è¡Œçš„æ•°æ®ï¼Œå°±ä¼šå¯¼è‡´å…¶ä»–cpuæ ¸å¿ƒçš„è¿™ä¸ªç¼“å­˜è¡Œéƒ½å¤±æ•ˆï¼Œä»è€Œè®©è¿™ä¸ªcpuæ ¸å¿ƒé‡æ–°åˆ°å†…å­˜ä¸­åŒºè¯»å–å¤åˆ¶æ•°æ®åˆ°ç¼“å­˜ä¸­ã€‚ä¸€ä¸ªç¼“å­˜è¡Œå¤§å°ä¸€èˆ¬æ˜¯64Byte</li>
<li>å¦‚æœcpu æ ¸å¿ƒ1å»ä¿®æ”¹cell[0]ï¼Œcpuæ ¸å¿ƒ2å»ä¿®æ”¹cell[1] ã€‚è¿™æ ·å°±ä¼šå¯¼è‡´æ•´è¡Œéƒ½ä¼šå¤±æ•ˆï¼Œä»è€Œå†æ¬¡åˆ°å†…å­˜ä¸­å»è¯»å–æœ€æ–°æ•°æ®</li>
<li>å¦‚æœæŠŠcell[0]å’Œcell[1]åˆ†åˆ«å ç”¨ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå°±èƒ½é¿å…è¿™ç§æƒ…å†µï¼ˆå°†ä¸€ä¸ªç¼“å­˜è¡Œç”¨ç©ºæ•°æ®å¡«æ»¡ï¼Œæ•…å°±ä¼šä¸€ä¸ªcellå ç”¨ä¸€è¡Œï¼‰</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230811205329597.png" alt="image-20230811205329597"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230811210320364.png" alt="image-20230811210320364"></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡ ä¸ªé‡è¦çš„å±æ€§</span></span><br><span class="line"><span class="comment">/** Number of CPUS, to place bound on table size */</span> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NCPU</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors(); <span class="comment">// cpuæ ¸å¿ƒæ•°</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells; <span class="comment">// cellæ•°ç»„ï¼Œå¤§å°æ¯æ¬¡x2</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base value, used mainly when there is no contention, but also as</span></span><br><span class="line"><span class="comment">     * a fallback during table initialization races. Updated via CAS.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> base; <span class="comment">// åŸºæ•°</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating Cells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy; <span class="comment">// cellé”,åˆ›å»ºcellæ—¶ä¼šä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">casBase</span><span class="params">(<span class="type">long</span> cmp, <span class="type">long</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="built_in">this</span>, BASE, cmp, val);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getProbe</span><span class="params">()</span> &#123; <span class="comment">// è·å–çº¿ç¨‹çš„æ¢æµ‹å€¼ï¼Œç±»ä¼¼çº¿ç¨‹çš„hash</span></span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getInt(Thread.currentThread(), PROBE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">    Cell[] as; <span class="type">long</span> b, v; <span class="type">int</span> m; Cell a;</span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> || !casBase(b = base, b + x)) &#123; <span class="comment">// cellsä¸ç­‰äºnull æˆ–è€… baseè¿›è¡ŒCASå¤±è´¥ä¼šè¿›å…¥</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> || <span class="comment">// cellsç­‰äºnullæˆ–è€…cellsçš„é•¿åº¦å°äº0</span></span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="literal">null</span> || <span class="comment">// æˆ–è€…cellsä¸‹æ ‡ä¸º getProbe() &amp; m ä¸º null</span></span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x))) <span class="comment">// æˆ–è€…ä¸Šæ–¹çš„aè¿›è¡ŒCASå¤±è´¥ä¼šè¿›å…¥ä¸‹æ–¹</span></span><br><span class="line">            longAccumulate(x, <span class="literal">null</span>, uncontended);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// longAccumulate</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">longAccumulate</span><span class="params">(<span class="type">long</span> x, LongBinaryOperator fn,</span></span><br><span class="line"><span class="params">                          <span class="type">boolean</span> wasUncontended)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">collide</span> <span class="operator">=</span> <span class="literal">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Cell[] as; Cell a; <span class="type">int</span> n; <span class="type">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123; <span class="comment">// cellså­˜åœ¨ï¼Œä¸”é•¿åº¦å¤§äº0</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="literal">null</span>) &#123; </span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;       <span class="comment">// Try to attach new Cell  cellsBusy == 0æœªä¸Šé”</span></span><br><span class="line">                    <span class="type">Cell</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cell</span>(x);   <span class="comment">// Optimistically create æ–°å»ºä¸€ä¸ªCell</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123; <span class="comment">// cellsBusy == 0 ä¸”ä¸Šé”</span></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">created</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            Cell[] rs; <span class="type">int</span> m, j; <span class="comment">// ä¸Šæ–¹åˆ›å»ºçš„ä¸€ä¸ªæ–°çš„cellå­˜å‚¨åˆ°cellsä¸­ï¼Œå¦‚æœcellså½“å‰ä¸‹æ ‡ä¸ºnullçš„è¯</span></span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="literal">null</span>) &#123;</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created) <span class="comment">// åˆ›å»ºæˆåŠŸï¼Œé€€å‡º</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                wasUncontended = <span class="literal">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="literal">null</span>) ? v + x :</span><br><span class="line">                                         fn.applyAsLong(v, x)))) <span class="comment">// å¯¹aè¿›è¡ŒCASï¼ŒæˆåŠŸåˆ™é€€å‡º</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)<span class="comment">// è¶…è¿‡cpuæ ¸å¿ƒæ•°</span></span><br><span class="line">                collide = <span class="literal">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;      <span class="comment">// Expand table unless stale æ‰©å®¹cells</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        cells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123; <span class="comment">// åˆå§‹cells</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">init</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Cell</span>(x);</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="literal">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="keyword">break</span>;                          <span class="comment">// Fall back on using base å†æ¬¡å¯¹xè¿›è¡ŒCas,æˆåŠŸåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h5><p>è¿™ä¸ªç±»æ¯”è¾ƒå¼ºå¤§ï¼Œå¯ä»¥æ“ä½œå†…å­˜ã€å¯¹å†…å­˜çš„åˆ†é…ã€å¤åˆ¶ã€é‡Šæ”¾ã€å¯¹è±¡çš„æ“ä½œã€çº¿ç¨‹è°ƒåº¦ã€CASæ“ä½œã€å’Œä¸€äº›ç³»ç»Ÿä¿¡æ¯</p>
<h3 id="ä¸å¯å˜"><a href="#ä¸å¯å˜" class="headerlink" title="ä¸å¯å˜"></a>ä¸å¯å˜</h3><h5 id="DateTimeFormatter"><a href="#DateTimeFormatter" class="headerlink" title="DateTimeFormatter"></a>DateTimeFormatter</h5><p>æ­¤ç±»æ˜¯ä¸€ä¸ªä¸å¯å˜å¹¶ä¸”çº¿ç¨‹å®‰å…¨çš„ç±» (This class is immutable and thread-safe)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸å®‰å…¨</span></span><br><span class="line"><span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy/MM/dd&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">parse</span> <span class="operator">=</span> simpleDateFormat.parse(<span class="string">&quot;2023/8/12&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, parse);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨</span></span><br><span class="line"><span class="type">DateTimeFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy/MM/dd&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="type">TemporalAccessor</span> <span class="variable">parse</span> <span class="operator">=</span> formatter.parse(<span class="string">&quot;2023/08/12&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, parse);</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ä¸å¯å˜å¯¹è±¡è®¾è®¡"><a href="#ä¸å¯å˜å¯¹è±¡è®¾è®¡" class="headerlink" title="ä¸å¯å˜å¯¹è±¡è®¾è®¡"></a>ä¸å¯å˜å¯¹è±¡è®¾è®¡</h5><p>String æ˜¯ä¸å¯å˜çš„ï¼Œå¹¶ä¸”å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯é€šè¿‡copyæ¥èµ‹å€¼æˆ–è¿”å›æ•°æ®ï¼Œè¿™æ ·å°±èƒ½é˜²æ­¢å¯¹åŸæ•°æ®æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(beginIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> value.length - beginIndex;</span><br><span class="line">    <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StringIndexOutOfBoundsException</span>(subLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="built_in">this</span> : <span class="keyword">new</span> <span class="title class_">String</span>(value, beginIndex, subLen); <span class="comment">// å¦‚æœå¼€å§‹ä¸º0ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦æ•°ç»„å¯¹è±¡ï¼Œå¦åˆ™newä¸€ä¸ªStringå¯¹è±¡</span></span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h5 id="finalåŸç†"><a href="#finalåŸç†" class="headerlink" title="finalåŸç†"></a>finalåŸç†</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">LINENUMBER <span class="number">8</span> L0</span><br><span class="line">ALOAD <span class="number">0</span></span><br><span class="line">INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V</span><br><span class="line">LINENUMBER <span class="number">9</span> L1</span><br><span class="line">ALOAD <span class="number">0</span></span><br><span class="line">BIPUSH <span class="number">100</span> <span class="comment">// å¤åˆ¶ä¸€ä»½açš„å€¼ï¼Œå¹¶ä¸æ˜¯getstaticæŒ‡ä»¤</span></span><br><span class="line">PUTFIELD nochange/connectionPool.a : I</span><br><span class="line">RETURN</span><br></pre></td></tr></table></figure>

<h5 id="æ‰‹å†™-ç®€å•è¿æ¥æ± "><a href="#æ‰‹å†™-ç®€å•è¿æ¥æ± " class="headerlink" title="æ‰‹å†™-ç®€å•è¿æ¥æ± "></a>æ‰‹å†™-ç®€å•è¿æ¥æ± </h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray locks;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Connection&gt; connections;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> PoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectionPool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.PoolSize = poolSize;</span><br><span class="line">        <span class="built_in">this</span>.locks = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(PoolSize);</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(PoolSize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++)</span><br><span class="line">            connections.add(<span class="keyword">new</span> <span class="title class_">Connection</span>(UUID.randomUUID().toString().split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; PoolSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (locks.get(i) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        locks.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> connections.get(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¾ªç¯ä¸€æ¬¡éƒ½è¢«å ç”¨äº†</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;ç­‰å¾…ä¸­..&quot;</span>);</span><br><span class="line">                    wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection coon)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; PoolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections.get(i) == coon) &#123;</span><br><span class="line">                locks.compareAndSet(i, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();</span><br><span class="line">                    log.debug(<span class="string">&quot;é‡Šæ”¾ &#123;&#125;&quot;</span>, coon.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;é‡Šæ”¾å¤±è´¥, æœªæ‰¾åˆ°å¯¹åº”Connection&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">connectionPool</span> <span class="variable">connectionPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">connectionPool</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">                <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionPool.get();</span><br><span class="line">                log.debug(<span class="string">&quot;çº¿ç¨‹ &#123;&#125;, è·å–åˆ°äº† &#123;&#125;&quot;</span>, Thread.currentThread().getName(), connection.getName());</span><br><span class="line">                connectionPool.free(connection);</span><br><span class="line">            &#125;, <span class="string">&quot;therad-&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Connection</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Connection</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h3><h5 id="çº¿ç¨‹æ± å¤§æ¦‚æ‰§è¡Œæ­¥éª¤"><a href="#çº¿ç¨‹æ± å¤§æ¦‚æ‰§è¡Œæ­¥éª¤" class="headerlink" title="çº¿ç¨‹æ± å¤§æ¦‚æ‰§è¡Œæ­¥éª¤"></a>çº¿ç¨‹æ± å¤§æ¦‚æ‰§è¡Œæ­¥éª¤</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. If fewer than corePoolSize threads are running, try to start a new thread with the given <span class="built_in">command</span> as its first task. The call to addWorker atomically checks runState and workerCount, and so prevents <span class="literal">false</span> alarms that would add threads when it shouldn<span class="string">&#x27;t, by returning false. </span></span><br><span class="line"><span class="string">2. If a task can be successfully queued, then we still need to double-check whether we should have added a thread (because existing ones died since last checking) or that the pool shut down since entry into this method. So we recheck state and if necessary roll back the enqueuing if stopped, or start a new thread if there are none.</span></span><br><span class="line"><span class="string">3. If we cannot queue task, then we try to add a new thread. If it fails, we know we are shut down or saturated and so reject the task.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1.å¦‚æœè¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œè¯·å°è¯•ä»¥ç»™å®šçš„å‘½ä»¤ä½œä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡æ¥å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚å¯¹addWorkerçš„è°ƒç”¨åŸå­æ€§åœ°æ£€æŸ¥runStateå’ŒworkerCountï¼Œä»è€Œé€šè¿‡è¿”å›falseæ¥é˜²æ­¢é”™è¯¯è­¦æŠ¥ï¼Œè¿™äº›é”™è¯¯è­¦æŠ¥ä¼šåœ¨ä¸åº”è¯¥æ·»åŠ çº¿ç¨‹çš„æƒ…å†µä¸‹æ·»åŠ çº¿ç¨‹ã€‚</span></span><br><span class="line"><span class="string">2.å¦‚æœä¸€ä¸ªä»»åŠ¡å¯ä»¥æˆåŠŸæ’é˜Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»ç„¶éœ€è¦ä»”ç»†æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦åº”è¯¥æ·»åŠ ä¸€ä¸ªçº¿ç¨‹ï¼ˆå› ä¸ºç°æœ‰çº¿ç¨‹è‡ªä¸Šæ¬¡æ£€æŸ¥ä»¥æ¥å·²ç»æ­»äº¡ï¼‰ï¼Œæˆ–è€…æ± è‡ªè¿›å…¥è¯¥æ–¹æ³•ä»¥æ¥å·²ç»å…³é—­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é‡æ–°æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œå¦‚æœåœæ­¢ï¼Œåˆ™å›æ»šæ’é˜Ÿï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚</span></span><br><span class="line"><span class="string">3.å¦‚æœä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°è¯•æ·»åŠ ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚å¦‚æœå®ƒå¤±è´¥äº†ï¼Œæ‹’ç»æ‰§è¡Œä»»åŠ¡ã€‚</span></span><br></pre></td></tr></table></figure>

<h5 id="è‡ªå®šä¹‰çº¿ç¨‹æ± å®ç°"><a href="#è‡ªå®šä¹‰çº¿ç¨‹æ± å®ç°" class="headerlink" title="è‡ªå®šä¹‰çº¿ç¨‹æ± å®ç°"></a>è‡ªå®šä¹‰çº¿ç¨‹æ± å®ç°</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230812131941708.png" alt="image-20230812131941708"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPool</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, (queue, task) -&gt; &#123;</span><br><span class="line"><span class="comment">//            queue.put((Runnable) task);</span></span><br><span class="line">            log.debug(<span class="string">&quot;æ‹’ç»ä»»åŠ¡ &#123;&#125;&quot;</span>, task);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 10ä¸ªä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">cur</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.excute(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ä»»åŠ¡-&#123;&#125;&quot;</span>, cur);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue blockingQueue;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;Worker&gt; workers;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> workerNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> blockingQueueSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> delay;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPool</span><span class="params">(<span class="type">int</span> workerNum, <span class="type">int</span> blockingQueueSize, <span class="type">long</span> delay, RejectPolicy rejectPolicy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.workerNum = workerNum;</span><br><span class="line">        <span class="built_in">this</span>.blockingQueueSize = blockingQueueSize;</span><br><span class="line">        <span class="built_in">this</span>.blockingQueue = <span class="keyword">new</span> <span class="title class_">BlockingQueue</span>(blockingQueueSize, rejectPolicy);</span><br><span class="line">        <span class="built_in">this</span>.workers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(workerNum);</span><br><span class="line">        <span class="built_in">this</span>.delay = TimeUnit.NANOSECONDS.convert(delay, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">excute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (workers.size() != workerNum) &#123;</span><br><span class="line">                <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ”¾å…¥&quot;</span>);</span><br><span class="line"><span class="comment">//                blockingQueue.put(task);</span></span><br><span class="line">                blockingQueue.rejectPut(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// ç›´åˆ°æŠŠå½“å‰ä»»åŠ¡å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œ</span></span><br><span class="line">            <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = blockingQueue.get(delay)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ­£åœ¨æ‰§è¡Œä»»åŠ¡&quot;</span>);</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç§»é™¤ worker</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                workers.remove(<span class="built_in">this</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;ç§»é™¤ &#123;&#125;&quot;</span>, <span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockingQueue</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line">    <span class="keyword">private</span> ArrayDeque&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">emptySet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">fullSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlockingQueue</span><span class="params">(<span class="type">int</span> capacity, RejectPolicy rejectPolicy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.tasks = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;(capacity);</span><br><span class="line">        <span class="built_in">this</span>.rejectPolicy = rejectPolicy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡è·å–</span></span><br><span class="line">    <span class="keyword">public</span> Runnable <span class="title function_">get</span><span class="params">(<span class="type">long</span> delay)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (tasks.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    delay = emptySet.awaitNanos(delay);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> tasks.peek() == <span class="literal">null</span> ? <span class="literal">null</span> : tasks.removeFirst();</span><br><span class="line">            fullSet.signal();</span><br><span class="line">            <span class="keyword">return</span> task;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (capacity == tasks.size()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fullSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            tasks.add(task);</span><br><span class="line">            emptySet.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸¦ç­–ç•¥æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectPut</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (tasks.size() == capacity) &#123;</span><br><span class="line">                rejectPolicy.reject(<span class="built_in">this</span>, task);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tasks.add(task);</span><br><span class="line">                emptySet.signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">RejectPolicy</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(BlockingQueue queue, T task)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h5><p>ä¸å»ºè®®ç”¨ï¼Œä¼šæœ‰OOM</p>
<p>çº¿ç¨‹æ± çŠ¶æ€ï¼Œintçš„é«˜3ä¸ºæ¥è¡¨ç¤ºçŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡ï¼Œæ•…å¤§å°é¡ºåºæ’åºä¾æ¬¡ä¸º TERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230813104713577.png" alt="image-20230813104713577"></p>
<p>è¿™äº›ä¿¡æ¯æ¬¡å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ä¸­ctlï¼Œç›®çš„æ˜¯å°†çŠ¶æ€å’Œçº¿ç¨‹æ•°åˆäºŒä¸ºä¸€ï¼Œä»¥ä¸€æ¬¡CASæ“ä½œå°±è¡Œäº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹æ—§çš„cè¿›è¡ŒCASï¼ŒctlOfæ˜¯åˆå¹¶ä¸¤ä¸ªå˜é‡</span></span><br><span class="line">ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))))</span><br><span class="line"></span><br><span class="line"><span class="comment">// c &amp; ä¸Šcapacity </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;   </span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå¹¶ä¸¤ä¸ªå˜é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>

<h6 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime, // ç”Ÿå­˜æ—¶é—´-é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</span></span><br><span class="line"><span class="params">                          TimeUnit unit, // æ—¶é—´å•ä½</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue, // é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory, // çº¿ç¨‹å·¥å‚</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span> &#123; <span class="comment">// æ‹’ç»ç­–ç•¥</span></span><br></pre></td></tr></table></figure>

<h6 id="JDKä¸­æ‹’ç»ç­–ç•¥çš„å®ç°ç±»"><a href="#JDKä¸­æ‹’ç»ç­–ç•¥çš„å®ç°ç±»" class="headerlink" title="JDKä¸­æ‹’ç»ç­–ç•¥çš„å®ç°ç±»"></a>JDKä¸­æ‹’ç»ç­–ç•¥çš„å®ç°ç±»</h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://boluokk.gitee.io/blog/assets/blogImg/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B.assets/image-20230813113714713.png" alt="image-20230813113714713"></p>
<blockquote>
<ol>
<li>AortPolicy è®©è°ƒç”¨è€…æŠ›å‡ºrejectExceptionå¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥</li>
<li>CallerPolicy è®©è°ƒç”¨è€…è¿è¡Œä»»åŠ¡</li>
<li>DiscardPolicy æ”¾å¼ƒæœ¬æ¬¡ä»»åŠ¡</li>
<li>DiscardOldestPolicy æ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œæœ¬ä»»åŠ¡å–è€Œä»£ä¹‹</li>
</ol>
</blockquote>
<h5 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h5><h6 id="newFixedThreadPool"><a href="#newFixedThreadPool" class="headerlink" title="newFixedThreadPool"></a>newFixedThreadPool</h6><blockquote>
<ol>
<li>æ²¡æœ‰æ•‘æ€¥çº¿ç¨‹ï¼Œé‡å»ºå‡ºæ¥çš„å…¨æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œé˜Ÿåˆ—ä¹Ÿæ˜¯é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡</li>
<li>å¹¶ä¸”å¯ä»¥åŠ¨æ€ä¿®æ”¹çº¿æ ¸å¿ƒçº¿ç¨‹ä¸ªæ•°</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads, ThreadFactory threadFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(),</span><br><span class="line">                                  threadFactory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="newCachedThreadPool"><a href="#newCachedThreadPool" class="headerlink" title="newCachedThreadPool"></a>newCachedThreadPool</h6><blockquote>
<ol>
<li>å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼Œæ— æ ¸å¿ƒçº¿ç¨‹</li>
<li>60s å›æ”¶æ•‘æ€¥</li>
<li>é˜Ÿåˆ—é‡‡ç”¨ SynchronousQueue ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰ç°æˆæ¥å–æ˜¯æ”¾ä¸è¿›å»çš„ï¼ˆä¸€æ‰‹äº¤é’±ï¼Œä¸€æ‰‹äº¤è´§ï¼‰</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                  <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="newSingleThreadExecutor"><a href="#newSingleThreadExecutor" class="headerlink" title="newSingleThreadExecutor"></a>newSingleThreadExecutor</h6><blockquote>
<ol>
<li>å•çº¿ç¨‹</li>
<li>è¾ƒé€‚åˆä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥ä»£æ›¿å½“å‰å¼‚å¸¸çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æäº¤ä»»åŠ¡"><a href="#æäº¤ä»»åŠ¡" class="headerlink" title="æäº¤ä»»åŠ¡"></a>æäº¤ä»»åŠ¡</h5><h6 id="submit"><a href="#submit" class="headerlink" title="submit()"></a>submit()</h6><blockquote>
<p>æäº¤ä»»åŠ¡ï¼Œå¯ä»¥æ˜¯Runnable æˆ–è€…æ˜¯æœ‰è¿”å›å€¼çš„Callable</p>
</blockquote>
<h6 id="invokeAll"><a href="#invokeAll" class="headerlink" title="invokeAll()"></a>invokeAll()</h6><blockquote>
<p>æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡</p>
</blockquote>
<h6 id="invokeAny"><a href="#invokeAny" class="headerlink" title="invokeAny()"></a>invokeAny()</h6><blockquote>
<p>æ‰§è¡Œä»»æ„ä¸€ä¸ª</p>
</blockquote>
<h6 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown()"></a>shutdown()</h6><blockquote>
<ol>
<li>ä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡ï¼Œå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œç„¶åç»“æŸæ‰</li>
<li>å¼‚æ­¥çš„ï¼Œè°ƒç”¨è€…å¹¶ä¸ä¼šç­‰å¾…ä»–æ‰§è¡Œå®Œæˆ</li>
</ol>
</blockquote>
<h6 id="shutdownnow"><a href="#shutdownnow" class="headerlink" title="shutdownnow()"></a>shutdownnow()</h6><blockquote>
<ol>
<li>ä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸ä¼šå¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½ä¸å†æ‰§è¡Œï¼Œç›´æ¥é€€å‡º</li>
<li>ä¼šè¿”å›æœªæ‰§è¡Œçš„ä»»åŠ¡é›†åˆ</li>
</ol>
</blockquote>
<h5 id="å·¥ä½œçº¿ç¨‹æ¨¡å¼"><a href="#å·¥ä½œçº¿ç¨‹æ¨¡å¼" class="headerlink" title="å·¥ä½œçº¿ç¨‹æ¨¡å¼"></a>å·¥ä½œçº¿ç¨‹æ¨¡å¼</h5><blockquote>
<p>è®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼Œæ¥è½®æµæ‰§è¡Œä»»åŠ¡ã€‚å…¸å‹çš„å°±æ˜¯çº¿ç¨‹æ± ï¼Œä½“ç°å‡ºäº†äº«å…ƒæ¨¡å¼è®¾è®¡æ¨¡å¼</p>
</blockquote>
<h6 id="é¥¥é¥¿-å›ºå®šçº¿ç¨‹æ± "><a href="#é¥¥é¥¿-å›ºå®šçº¿ç¨‹æ± " class="headerlink" title="é¥¥é¥¿-å›ºå®šçº¿ç¨‹æ± "></a>é¥¥é¥¿-å›ºå®šçº¿ç¨‹æ± </h6><p>çº¿ç¨‹æ± åªæœ‰ä¸¤ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸‹æ–¹ä¼šå¯¼è‡´çº¿ç¨‹æ•°ä¸å¤Ÿç”¨ï¼Œå¡åœ¨è·å–submitç»“æœçš„ä½ç½®ï¼Œå› ä¸ºæ²¡æœ‰ç°æˆå»å¤„ç†submitæäº¤çš„ä»»åŠ¡ã€‚æœ€ç»ˆåˆ°å°†å‡ºç°é¥¥é¥¿çš„ç°è±¡, ä¸æ˜¯æ­»é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">service.execute(()-&gt;&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;è¿›å…¥&quot;</span>);</span><br><span class="line">    Future&lt;String&gt; submit = service.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> submit.get();</span><br><span class="line">        log.debug(str);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">service.execute(()-&gt;&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;è¿›å…¥&quot;</span>);</span><br><span class="line">    Future&lt;String&gt; submit = service.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> submit.get();</span><br><span class="line">        log.debug(str);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="åˆ›å»ºå¤šå°‘çº¿ç¨‹åˆé€‚"><a href="#åˆ›å»ºå¤šå°‘çº¿ç¨‹åˆé€‚" class="headerlink" title="åˆ›å»ºå¤šå°‘çº¿ç¨‹åˆé€‚"></a>åˆ›å»ºå¤šå°‘çº¿ç¨‹åˆé€‚</h5><blockquote>
<ol>
<li><p>cpuå¯†é›†å‹ï¼š cpuæ ¸æ•° + 1</p>
</li>
<li><p>ioå¯†é›†å‹ï¼š çº¿ç¨‹æ•° &#x3D; æ ¸æ•° * æœŸæœ›cpuåˆ©ç”¨ç‡ * æ€»æ—¶é—´(cpuè®¡ç®—æ—¶é—´+ç­‰å¾…æ—¶é—´) &#x2F; cpuè®¡ç®—æ—¶é—´</p>
<p>ä¾‹å¦‚: 4æ ¸ cpu è®¡ç®—æ—¶é—´æ˜¯ 50%ï¼Œå…¶ä»–ç­‰å¾…æ—¶é—´æ˜¯50%ï¼ŒæœŸæœ›cpuè¢«100åˆ©ç”¨</p>
<p>â€‹		4 * 100% * 100% &#x2F; 50 % &#x3D; 8</p>
</li>
</ol>
</blockquote>
<h5 id="ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "><a href="#ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± " class="headerlink" title="ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "></a>ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h5><h6 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h6><blockquote>
<ol>
<li>java.util.Timeræ¥å®ç°å®šæ—¶åŠŸèƒ½</li>
<li>Timerç®€å•æ˜“ç”¨ï¼Œä½†æ˜¯åªèƒ½ä¸²è¡Œæ‰§è¡Œï¼Œå¹¶ä¸”å¦‚æœæ²¡æœ‰æ•è·å¼‚å¸¸ä¼šå¯¼è‡´åé¢çš„ä»»åŠ¡ä¹Ÿæ— æ³•æ­£å¸¸æ‰§è¡Œ</li>
</ol>
</blockquote>
<h6 id="ScheduledThreadPoolExecutor"><a href="#ScheduledThreadPoolExecutor" class="headerlink" title="ScheduledThreadPoolExecutor"></a>ScheduledThreadPoolExecutor</h6><blockquote>
<ol>
<li>éä¸²è¡Œ</li>
<li>å¼‚å¸¸ä¸ä¼šå¯¼è‡´åé¢ä»»åŠ¡å¤±æ•ˆ</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    executorService.schedule(()-&gt;&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;sc1&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125;, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">    executorService.schedule(()-&gt;&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;sc2&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// scheduleAtFixedRate å®šæ—¶å¾ªç¯ä»»åŠ¡, ä»»åŠ¡ä¸­çš„sleep æˆ–è€… scheduleAtFixedRate å½¢å‚çš„é—´éš”æ—¶é—´ä¸¤ä¸ªä¸­çš„æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">// scheduleWithFixedDelay åˆ™æ˜¯ä¸¤ä¸ªæ—¶é—´ç›¸åŠ </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    executorService.scheduleAtFixedRate(()-&gt;&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;while&quot;</span>);</span><br><span class="line">    &#125;,<span class="number">0</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Fork-x2F-Join"><a href="#Fork-x2F-Join" class="headerlink" title="Fork&#x2F;Join"></a>Fork&#x2F;Join</h5><blockquote>
<p>JDK7æ–°å¢çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°åˆ†æ²»çš„å®ç°ï¼Œé€‚åˆç”¨æˆ·ä»»åŠ¡æ‹†åˆ†çš„cpuå¯†é›†å‹è¿ç®—</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForkJoinTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="type">ForkJoinTask</span> <span class="variable">forkJoinTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinTask</span>(<span class="number">3</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> forkJoinPool.submit(forkJoinTask).get();</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ForkJoinTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ForkJoinTask</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.n = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ForkJoinTask</span> <span class="variable">forkJoinTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinTask</span>(n - <span class="number">1</span>);</span><br><span class="line">        forkJoinTask.fork();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> forkJoinTask.join() + n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><ol>
<li>AbstractQuueudSynchronizedï¼Œé˜»å¡å¼é”</li>
<li>ç”¨stateå±æ€§æ¥è¡¨ç¤ºèµ„æºçŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦çš„å®šä¹‰å¦‚ä½•ç»´æŠ¤æ¢è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶è·å–å’Œé‡Šæ”¾é”</li>
<li>æä¾›åŸºäºFIFOçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼monitorçš„entrylist</li>
<li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¯¹ä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼monitorçš„waitset</li>
<li>ReentrantLock ä½¿ç”¨äº†æ­¤ç±»</li>
</ol>
<h5 id="æ‰‹å†™ä¸€ä¸ªä¸å¯é‡å…¥é”"><a href="#æ‰‹å†™ä¸€ä¸ªä¸å¯é‡å…¥é”" class="headerlink" title="æ‰‹å†™ä¸€ä¸ªä¸å¯é‡å…¥é”"></a>æ‰‹å†™ä¸€ä¸ªä¸å¯é‡å…¥é”</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><blockquote>
<ol>
<li><p>ä»…æœ¬çº¿ç¨‹èƒ½è·å–åˆ°æ­¤å¯¹è±¡ï¼Œä»è€Œå¯é˜²æ­¢å¤šçº¿ç¨‹æ•°æ®é—®é¢˜ï¼Œå¯èƒ½ä¼šOOM</p>
</li>
<li><p>å…¶ä¸­keyæ˜¯å¼±å¼•ç”¨(å½“å…¶ä»–æ‰€æœ‰å¯¹keyçš„å¼•ç”¨æ²¡æœ‰åï¼Œgcä¼šå°†æ­¤keyç»™å›æ”¶æ‰)</p>
</li>
<li><hr>
</li>
<li><p>get çš„æ—¶å€™å‘ç°keyä¸ºnullï¼Œä¼šä½¿valueè®¾ç½®ä¸ºnull (å¯èƒ½ä¹Ÿä¼šæ— æ•ˆ)</p>
</li>
<li><p>setçš„æ—¶å€™å‘ç°keyä¸ºnullï¼Œä¹Ÿä¼šä½¿valueè®¾ç½®ä¸ºnull (å¯èƒ½ä¹Ÿä¼šæ— æ•ˆ)</p>
</li>
<li><p>è°ƒç”¨remove()æ¨èï¼Œä¹Ÿä¼šä½¿valueä¸ºnull</p>
</li>
</ol>
</blockquote>
<h5 id="åŸç†-6"><a href="#åŸç†-6" class="headerlink" title="åŸç†"></a>åŸç†</h5><h3 id="çº¿ç¨‹å®‰å…¨é›†åˆç±»"><a href="#çº¿ç¨‹å®‰å…¨é›†åˆç±»" class="headerlink" title="çº¿ç¨‹å®‰å…¨é›†åˆç±»"></a>çº¿ç¨‹å®‰å…¨é›†åˆç±»</h3><h5 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h5><p>é€šè¿‡é›†åˆå·¥å…·ç±»ï¼Œæ¥åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„é›†åˆå¯¹è±¡, åº•å±‚è¿˜æ˜¯é€šè¿‡synchronizedé”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<blockquote>
<ul>
<li>synchronizedList </li>
<li>synchronizedMap</li>
</ul>
</blockquote>
<h5 id="HashMap-JDK7-æ‰©å®¹æ­»é“¾"><a href="#HashMap-JDK7-æ‰©å®¹æ­»é“¾" class="headerlink" title="HashMap-JDK7-æ‰©å®¹æ­»é“¾"></a>HashMap-JDK7-æ‰©å®¹æ­»é“¾</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// å‡å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBï¼Œæœ‰æ®µé“¾è¡¨å€¼æ˜¯1-&gt;2-&gt;null, æ­¤æ—¶çº¿ç¨‹Aå…ˆè¿›å…¥åˆ°transferçš„next = e.nextï¼ˆ5ï¼‰æ­¤å¤„åœä¸‹ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°çº¿ç¨‹Bï¼Œçº¿ç¨‹Bç›´æ¥ä¸€ä¸‹æŠŠè¿™æ®µé“¾è¡¨ä¸ªç»™æ‰©å®¹äº†ï¼Œæ­¤æ—¶ 2 - 1 - &gt; nullï¼Œä½†æ˜¯Açº¿ç¨‹åˆå°†1å¤´æ’å…¥åˆ°æ–°èŠ‚ç‚¹ä¸­ï¼Œæ‰€æœ‰å°±å¯¼è‡´äº†1-&gt;2 -&gt; 1ï¼Œè¿™æ ·å°±æˆæ­»é“¾äº†</span></span><br><span class="line"> <span class="number">1</span>    <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Entry[] newTable, <span class="type">boolean</span> rehash)</span> &#123;</span><br><span class="line">     	   <span class="comment">//è·å–æ–°Entryæ•°ç»„çš„å®¹é‡</span></span><br><span class="line"> <span class="number">2</span>         <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;</span><br><span class="line">     	   <span class="comment">//éå†æ—§çš„Entryæ•°ç»„</span></span><br><span class="line"> <span class="number">3</span>         <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">     	   <span class="comment">// eçš„ä¸‹ä¸€ä¸ªentryä¸ä¸ºnullåˆ™å¾ªç¯ï¼ˆé“¾è¡¨ä¸Šçš„å¾ªç¯ï¼‰</span></span><br><span class="line"> <span class="number">4</span>             <span class="keyword">while</span>(<span class="literal">null</span> != e) &#123;</span><br><span class="line"> <span class="number">5</span>                 Entry&lt;K,V&gt; next = e.next;</span><br><span class="line"> <span class="number">6</span>                 <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line"> <span class="number">7</span>                     e.hash = <span class="literal">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line"> <span class="number">8</span>                 &#125;</span><br><span class="line">     				<span class="comment">//æ ¹æ®eçš„hashå€¼å’Œå®¹é‡è®¡ç®—å‡ºindexå€¼</span></span><br><span class="line"> <span class="number">9</span>                 <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, newCapacity);</span><br><span class="line">     			    <span class="comment">//eçš„ä¸‹ä¸€ä¸ªEntryä¸ºæ–°æ•°ç»„iä½ç½®ä¸Šçš„å€¼</span></span><br><span class="line"><span class="number">10</span>                 e.next = newTable[i];</span><br><span class="line">     				<span class="comment">//eæ·»åŠ åˆ°æ–°æ•°ç»„çš„iä½ç½®ä¸Š</span></span><br><span class="line"><span class="number">11</span>                 newTable[i] = e;</span><br><span class="line">     				<span class="comment">//nextèµ‹å€¼ç»™e</span></span><br><span class="line"><span class="number">12</span>                 e = next;</span><br><span class="line"><span class="number">13</span>             &#125;</span><br><span class="line"><span class="number">14</span>         &#125;</span><br><span class="line"><span class="number">15</span>     &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hashè¡¨</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The next table to use; non-null only while resizing.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Base counter value, used mainly when there is no contention,</span></span><br><span class="line"><span class="comment">    * but also as a fallback during table initialization</span></span><br><span class="line"><span class="comment">    * races. Updated via CAS.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> baseCount;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Table initialization and resizing control.  When negative, the</span></span><br><span class="line"><span class="comment">    * table is being initialized or resized: -1 for initialization,</span></span><br><span class="line"><span class="comment">    * else -(1 + the number of active resizing threads).  Otherwise,</span></span><br><span class="line"><span class="comment">    * when table is null, holds the initial table size to use upon</span></span><br><span class="line"><span class="comment">    * creation, or 0 for default. After initialization, holds the</span></span><br><span class="line"><span class="comment">    * next element count value upon which to resize the table.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> sizeCtl;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The next table index (plus one) to split while resizing.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> transferIndex;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// views</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> KeySetView&lt;K,V&gt; keySet;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> ValuesView&lt;K,V&gt; values;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> EntrySetView&lt;K,V&gt; entrySet;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹æ—¶å¦‚æœæŸä¸ª bin è¿ç§»å®Œæ¯•ï¼Œç”¨ ForwardingNode ä½œä¸ºæ—§çš„ table bin çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt;</span><br><span class="line">   <span class="comment">// ç”¨åœ¨ compute ä»¥åŠ computeIfAbsent æ—¶ï¼Œç”¨æ¥å ä½ï¼Œè®¡ç®—å®Œæˆåæ›¿æ¢ä¸ºæ™®é€š Node</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ReservationNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt;</span><br><span class="line">   <span class="comment">// ç”¨ä½œ treebin çš„å¤´ç»“ç‚¹ï¼Œå­˜å‚¨ root å’Œ first</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeBin</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt;</span><br><span class="line">   <span class="comment">// ä½œä¸º treebin çš„èŠ‚ç‚¹ï¼Œå­˜å‚¨ parentï¼Œleftï¼Œright</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="æ„é€ å™¨"><a href="#æ„é€ å™¨" class="headerlink" title="æ„é€ å™¨"></a>æ„é€ å™¨</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// æœ‰å‚æ— å‚éƒ½ä¸ä¼šå¯¹tableè¿›è¡Œåˆå§‹åŒ–ï¼Œæœ‰å‚ä»…ä»…æ˜¯å¯¹tableçš„å®¹é‡è¿›è¡Œè®¡ç®—</span></span><br><span class="line"><span class="comment">// æ— å‚</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new, empty map with the default initial table size (16).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">()</span> &#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ‰å‚</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">      	<span class="comment">// å®¹é‡å°äº0ï¼ŒæŠ›å¼‚å¸¸</span></span><br><span class="line">       <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">       <span class="comment">// åˆå§‹åŒ–å¤§å°å¤§äº æœ€å¤§å®¹é‡æ— ç¬¦å·å³ç§»1ä½ï¼Œå¦åˆ™é‡‡ç”¨ tableSizeFor ç®—å‡º2^nçš„å¤§å°å®¹é‡</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">                  MAXIMUM_CAPACITY :</span><br><span class="line">                  <span class="comment">// åˆå§‹å®¹é‡ + 1/2åˆå§‹å®¹é‡ + 1ï¼Œè¶…è¿‡1.5å€çš„åˆå§‹å®¹é‡</span></span><br><span class="line">                  tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">       <span class="comment">// tableå¤§å°</span></span><br><span class="line">       <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity,</span></span><br><span class="line"><span class="params">                            <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">       <span class="comment">// åŠ è½½å› å­å°äº0ã€åˆå§‹åŒ–å¤§äº0ã€å¹¶å‘ç­‰çº§å°äº0</span></span><br><span class="line">       <span class="comment">// æŠ›å‡ºå‚æ•°éæ³•å¼‚å¸¸</span></span><br><span class="line">       <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">      <span class="comment">// åˆå§‹å®¹é‡ &lt; å¹¶å‘ç­‰çº§ åˆ™é‡‡ç”¨å¹¶å‘ç­‰çº§å®¹é‡</span></span><br><span class="line">       <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">           initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">       <span class="comment">// ç®—å‡ºå®é™…å®¹é‡å¤§å°</span></span><br><span class="line">       <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">long</span>)(<span class="number">1.0</span> + (<span class="type">long</span>)initialCapacity / loadFactor);</span><br><span class="line">       <span class="comment">// åˆ¤å®šæ˜¯å¦è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> (size &gt;= (<span class="type">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">           MAXIMUM_CAPACITY : tableSizeFor((<span class="type">int</span>)size);</span><br><span class="line">       <span class="comment">// tableå¤§å°</span></span><br><span class="line">       <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="get"><a href="#get" class="headerlink" title="get()"></a>get()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœªé‡‡ç”¨åŠ é”çš„æ–¹å¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="type">int</span> n, eh; K ek;</span><br><span class="line">    <span class="comment">// è·å–éè´Ÿæ•°çš„hash ((h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS), HASH_BITS = Integerçš„æœ€å¤§å€¼ï¼Œæ•…æœ€é«˜ä½ä¸º0ï¼Œæ‰€ä»¥æœ€åæ€ä¹ˆ&amp;éƒ½æ˜¯ä¸€ä¸ªæ­£æ•°æˆ–è€…0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// å¦‚æœtableå·²ç»åˆå§‹åŒ–æˆ–è€…tableçš„é•¿åº¦&gt;0</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰hashæ‰€åœ¨çš„ä¸‹æ ‡çš„å¤´nodeï¼Œå¹¶ä¸”ä¸ä¸ºnull</span></span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¤´nodeçš„hash ç­‰äº ä¼ å…¥è¿›æ¥çš„keyçš„hash</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="comment">// å¹¶ä¸”å¤´nodeçš„key ç­‰äº ä¼ è¿›æ¥çš„key æˆ–è€… å¤´nodeçš„key equals ä¼ å…¥è¿›æ¥çš„ key</span></span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="comment">// ç›´æ¥è¿”å›å¤´nodeçš„å€¼</span></span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°äº0 è¡¨ç¤ºä¸º ForwardingNode èŠ‚ç‚¹ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯çº¢é»‘æ ‘(å› ä¸ºç¬¬ä¸€ä¸ªçš„hashé»˜è®¤ä¸º-1ï¼Œçº¢é»‘æ ‘ çš„hashé»˜è®¤ä¸º-2)</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// è°ƒç”¨ ForwardingNode æˆ–è€… çº¢é»‘æ ‘ çš„findæ–¹æ³•æŸ¥æ‰¾å€¼è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="literal">null</span> ? p.val : <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// é“¾è¡¨ï¼Œéå†è·å–å€¼</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="put"><a href="#put" class="headerlink" title="put()"></a>put()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// å‚æ•°åˆ—è¡¨: é”®ï¼Œå€¼ï¼Œä»…å¯¹ä¸å­˜åœ¨çš„keyæ‰èµ‹å€¼(falseè¡¨ç¤ºç›¸åŒkeyè¿›è¡Œè¦†ç›–ï¼Œtrueè¡¨ç¤ºæ²¡æœ‰å½“å‰keyæ‰ä¼šå»æ·»åŠ )</span></span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="comment">// key æˆ–è€… value ä¸ºnullï¼Œç›´æ¥æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸, ä¸Hashtable ä¸€è‡´(Hashtableçš„keyä¸æ˜¯æ‰‹åŠ¨æŠ›å‡ºçš„è€Œæ˜¯è°ƒç”¨hashCode()é€ æˆçš„)</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span> || value == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// è·å–hash</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// æ¡¶çš„æ“ä½œæ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">// tableä¸ºnullï¼Œåˆå§‹åŒ–table</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="comment">// ä¸‹æ ‡å¤´ç»“ç‚¹ä¸ºnullï¼Œè¿›è¡Œæ–°å»ºå¤´node</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="literal">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå¤´nodeçš„hash ç­‰äº -1ï¼Œè¡¨ç¤ºæ­£éœ€è¦è¿ç§»æ‰©å®¹table</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// å¸®åŠ©å…¶ä»–çº¿ç¨‹è¿ç§»node</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¿®æ”¹æˆ–æ·»åŠ åŒºåŸŸ</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// é”ä½å½“å‰å¤´node</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå½“å‰tableï¼Œiä½ç½®çš„nodeæ˜¯ä¸Šæ–¹è·å–çš„node</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// fh &gt;= 0 è¡¨ç¤ºæ­£å¸¸hash</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ¡¶æ“ä½œæ•° = 1</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// å¼€å§‹è‡ªæ—‹ï¼Œå¯»æ‰¾èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// hash ä¸€è‡´</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                <span class="comment">// å¹¶ä¸” keyæ˜¯ä¸€ä¸ª</span></span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 <span class="comment">// æˆ–è€…keyç›¸åŒ</span></span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">// ä¿ç•™æŸ¥æ‰¾åˆ°çš„nodeçš„value</span></span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="comment">// æ˜¯å¦ä¸å­˜åœ¨æ‰è¦†ç›–</span></span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    <span class="comment">// æ›¿æ¢æ–°å€¼</span></span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// æ›´æ–°eï¼Œå·²ç»åˆ°è¾¾å½“å‰é“¾è¡¨çš„æœ«å°¾äº†ï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±æ–°å»º</span></span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="comment">// æœ«å°¾äº†ï¼Œä½†æ˜¯èŠ‚ç‚¹ä¸ºnull</span></span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// æ–°å»ºèŠ‚ç‚¹</span></span><br><span class="line">                                pred.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="literal">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// è°ƒç”¨çº¢é»‘æ ‘çš„putTreeValæ–¹æ³•ï¼Œæ·»åŠ æ•°æ®</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                              value)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¯¹æ•°æ®ä¿®æ”¹è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// binCount æ¬¡æ•° å¤§äº 8ï¼Œæ•…é“¾è¡¨é•¿åº¦å¤§äº 8</span></span><br><span class="line">                <span class="comment">// çº¢é»‘æ ‘æœ€å¤šä¸º 2</span></span><br><span class="line">                <span class="comment">// ä»€ä¹ˆéƒ½ä¸æ“ä½œä¸º 0</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// å¼€å§‹æ ‘åŒ–</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// è¿”å›æ—§å€¼</span></span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ“ä½œæ¬¡æ•° + 1ï¼Œå¹¶ä¸”åˆ¤å®šæ˜¯å¦éœ€è¦æ‰©å®¹tableç­‰</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="initTable"><a href="#initTable" class="headerlink" title="initTable()"></a>initTable()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ¡ä»¶ table ç­‰äº null æˆ–è€… tableçš„é•¿åº¦ ä¸º 0</span></span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// -1 &lt; 0ï¼šè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// ç¤¼è®©ç»™æ­£åœ¨åˆå§‹åŒ–tableçš„çº¿ç¨‹</span></span><br><span class="line">            Thread.<span class="keyword">yield</span>(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="comment">// å¦åˆ™è¿›è¡Œåˆå§‹åŒ–tableï¼Œå¯¹sizeCtlè¿›è¡Œcasä¿®æ”¹æˆ-1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å†åˆ¤æ–­ä¸€æ¬¡ï¼Œtableæ˜¯å¦ä¸ºnullï¼Œæˆ–è€…é•¿åº¦ä¸º0</span></span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// é‡ç½®å®¹é‡å¤§å°ï¼Œå¤§äº0ç”¨æœ¬èº«ï¼Œå¦åˆ™ç”¨é»˜è®¤ 16 </span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="comment">// æ–°å»ºtable</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                    <span class="comment">// èµ‹å€¼ç»™tableã€tab</span></span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">// n - 1/4*nï¼Œæ•…ç›¸å½“äºä¹˜ä»¥HashMapä¸­çš„åŠ è½½å› å­</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡ç½®sizeCtl</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›tab</span></span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="casTabAt"><a href="#casTabAt" class="headerlink" title="casTabAt()"></a>casTabAt()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡ä¸€ä¸ªåŸºæœ¬åç§»é‡ + i &lt;&lt; ASHIFT åç§»é‡ = tabä¸­ä¸‹æ ‡ä¸ºiçš„å€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="type">boolean</span> <span class="title function_">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i,</span></span><br><span class="line"><span class="params">                                    Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="helpTransfer"><a href="#helpTransfer" class="headerlink" title="helpTransfer()"></a>helpTransfer()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="comment">// tab ä¸ä¸ºnull å¹¶ä¸” f å±äº ForwardingNode</span></span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="literal">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">        <span class="comment">// å½“å‰nodeå¤´çš„nextTabä¸ä¸ºnull</span></span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(tab.length);</span><br><span class="line">        <span class="comment">// nextTabæ²¡æœ‰å˜åŒ–å¹¶ä¸”tabletä¹Ÿæ²¡æœ‰å˜,æ‰å¸®å¿™åšè¿ç§»</span></span><br><span class="line">        <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">               (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">              	<span class="comment">// è¿›è¡Œæ•°æ®è¿ç§»</span></span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="transfer"><a href="#transfer" class="headerlink" title="transfer()"></a>transfer()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> tab.length, stride;</span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">    <span class="comment">// å¦‚æœnextTab == null, å°±åˆå§‹åŒ–ä¸€ä¸ªnextTab</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="literal">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">nextn</span> <span class="operator">=</span> nextTab.length;</span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">advance</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">finishing</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> fh;</span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="type">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="built_in">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                bound = nextBound;</span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="type">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                nextTable = <span class="literal">null</span>;</span><br><span class="line">                table = nextTab;</span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                finishing = advance = <span class="literal">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»æ¬è¿å®Œäº†ï¼Œå°±æŠŠæ–°å»ºçš„ ForwardingNodeè´´ä¸Šå»</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="literal">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="literal">null</span>, fwd);</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰nodeçš„hash ç­‰äº -2</span></span><br><span class="line">        <span class="comment">// ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="literal">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ¬è¿ä»£ç </span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123; <span class="comment">// é“¾è¡¨æ¬è¿</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">runBit</span> <span class="operator">=</span> fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="literal">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> p.hash &amp; n;</span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">ph</span> <span class="operator">=</span> p.hash; <span class="type">K</span> <span class="variable">pk</span> <span class="operator">=</span> p.key; <span class="type">V</span> <span class="variable">pv</span> <span class="operator">=</span> p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                ln = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123; <span class="comment">// çº¢é»‘æ ‘æ¬è¿</span></span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">lc</span> <span class="operator">=</span> <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="literal">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="literal">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                        (hc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                        (lc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="COpy"><a href="#COpy" class="headerlink" title="COpy"></a>COpy</h5><h3 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h3><h4 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h4><h5 id="åŸç†-7"><a href="#åŸç†-7" class="headerlink" title="åŸç†"></a>åŸç†</h5><h6 id="put-1"><a href="#put-1" class="headerlink" title="put()"></a>put()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ä¸èƒ½ä¼ å…¥nullæ•°æ®ï¼Œå¦è€…ç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">    <span class="comment">// è·å–é”å’ŒåŸå­è‡ªå¢</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå®¹é‡æ»¡äº†ï¼Œå°±å¼€å§‹parkä½</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">        enqueue(node);</span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// å¦‚æœè¿˜å°äºå®¹é‡</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            <span class="comment">// é€šçŸ¥æ”¾æ•°æ®</span></span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾</span></span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// é€šçŸ¥æ‹¿æ•°æ®</span></span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> &#123;</span><br><span class="line">  	<span class="comment">// è¿½åŠ node</span></span><br><span class="line">    last = last.next = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="poll"><a href="#poll" class="headerlink" title="poll()"></a>poll()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="comment">// ç­‰äºè¡¨ç¤ºæ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›null</span></span><br><span class="line">    <span class="keyword">if</span> (count.get() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¤§äº0è¡¨ç¤ºæœ‰æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (count.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å‡ºé˜Ÿ</span></span><br><span class="line">            x = dequeue();</span><br><span class="line">            <span class="comment">// count - 1</span></span><br><span class="line">            c = count.getAndDecrement();</span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">                <span class="comment">// é€šçŸ¥æ‹¿æ•°æ®</span></span><br><span class="line">                notEmpty.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        <span class="comment">// é€šçŸ¥æ”¾æ•°æ®</span></span><br><span class="line">        signalNotFull();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> E <span class="title function_">dequeue</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;E&gt; h = head;</span><br><span class="line">    Node&lt;E&gt; first = h.next;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾ head</span></span><br><span class="line">    h.next = h; <span class="comment">// help GC</span></span><br><span class="line">    <span class="comment">// é‡ç½®å¤´ç»“ç‚¹</span></span><br><span class="line">    head = first;</span><br><span class="line">    <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> first.item;</span><br><span class="line">    <span class="comment">// å°†å¤´ç»“ç‚¹å†…å®¹ç½®ç©º</span></span><br><span class="line">    first.item = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// è¿”å›æ–°headçš„å€¼</span></span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ConcurrentLinkedQueue"><a href="#ConcurrentLinkedQueue" class="headerlink" title="ConcurrentLinkedQueue"></a>ConcurrentLinkedQueue</h4><h5 id="åŸç†-8"><a href="#åŸç†-8" class="headerlink" title="åŸç†"></a>åŸç†</h5><h6 id="add"><a href="#add" class="headerlink" title="add()"></a>add()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</span><br><span class="line">        Node&lt;E&gt; q = p.next;</span><br><span class="line">        <span class="keyword">if</span> (q == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.casNext(<span class="literal">null</span>, newNode)) &#123;</span><br><span class="line">                casTail(t, newNode);  <span class="comment">// Failure is OK.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">            p = (t != (t = tail)) ? t : head;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h3><blockquote>
<p>çº¿ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œexchange()ä¼šä¸€ç›´å µå¡ï¼Œç›´åˆ°æœ‰äººå’Œå®ƒäº¤æ¢æ•°æ®</p>
</blockquote>
<h5 id="ä½¿ç”¨-2"><a href="#ä½¿ç”¨-2" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    Exchanger&lt;Object&gt; exchanger = <span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">exchange</span> <span class="operator">=</span> exchanger.exchange(<span class="number">1</span>);</span><br><span class="line">            System.out.println(exchange);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    exchanger.exchange(<span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h3><blockquote>
<p>å¯ä»£æ›¿FutureTaskï¼Œå¯åšå¼‚æ­¥ä»»åŠ¡</p>
</blockquote>
<h5 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h5><ol>
<li>CompletableFuture.runAsync() æ— è¿”å›å€¼</li>
<li>CompletableFuture.supplyAsync() æœ‰è¿”å›å€¼</li>
</ol>
<h5 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h5><ol>
<li>supplyAsyncï¼šå¼€å¯å¼‚æ­¥ä»»åŠ¡</li>
<li>thenComposeï¼šè¿æ¥ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡</li>
<li>thenCombineï¼šåˆå¹¶ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡</li>
<li>thenApplyï¼šä»»åŠ¡çš„åç½®å¤„ç†</li>
<li>applyToEitherï¼šè·å–æœ€å…ˆå®Œæˆçš„ä»»åŠ¡</li>
<li>exceptionallyï¼šå¼‚å¸¸å¤„ç†</li>
<li>â€¦</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://boluokk.github.io/blog">ğŸ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://boluokk.github.io/blog/2023/08/27/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">https://boluokk.github.io/blog/2023/08/27/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://boluokk.github.io/blog" target="_blank">ğŸBlog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://source.fomal.cc/img/default_cover_49.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/2023/08/27/ArrayList%E6%BA%90%E7%A0%81/" title="ArrayListæºç "><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_29.webp" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ArrayListæºç </div></div></a></div><div class="next-post pull-right"><a href="/blog/2023/06/13/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/" title="Mysqlæ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»æ‰€äº§ç”Ÿé—®é¢˜"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_24.webp" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Mysqlæ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»æ‰€äº§ç”Ÿé—®é¢˜</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/blog/assets/img/avatar.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ğŸ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/blog/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">18</div></a><a href="/blog/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/blog/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/boluokk"><i class="fab fa-github"></i><span>Follow Me</span><!--i.faa-passing.animated(style="padding-left:20px;display:inline-block;vertical-align:middle;")--><!--  svg.icon(style="height:28px;width:28px;fill:currentColor;position:relative;top:5px")--><!--    use(xlink:href='#icon-xiaoqiche')--></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://gitee.com/boluokk" target="_blank" title="Gitee"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1352955539@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content"></div><div id="welcome-info"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">è¿›ç¨‹ä¸çº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91-amp-%E5%B9%B6%E8%A1%8C"><span class="toc-number">2.</span> <span class="toc-text">å¹¶å‘&amp;å¹¶è¡Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%90%8C%E6%AD%A5"><span class="toc-number">3.</span> <span class="toc-text">å¼‚æ­¥åŒæ­¥</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5"><span class="toc-number">3.0.1.</span> <span class="toc-text">åŒæ­¥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5"><span class="toc-number">3.0.2.</span> <span class="toc-text">å¼‚æ­¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%90%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">åˆ›å»ºè¿è¡Œçº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Thread"><span class="toc-number">4.0.1.</span> <span class="toc-text">Thread</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Runnable"><span class="toc-number">4.0.2.</span> <span class="toc-text">Runnable</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Thread%E5%92%8CRunnable%E5%8C%BA%E5%88%AB"><span class="toc-number">4.0.3.</span> <span class="toc-text">Threadå’ŒRunnableåŒºåˆ«</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#FutureTask"><span class="toc-number">4.0.4.</span> <span class="toc-text">FutureTask</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">æŸ¥çœ‹çº¿ç¨‹æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#windows"><span class="toc-number">5.0.1.</span> <span class="toc-text">windows</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#linux"><span class="toc-number">5.0.2.</span> <span class="toc-text">linux</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#java"><span class="toc-number">5.0.3.</span> <span class="toc-text">java</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">çº¿ç¨‹è¿è¡ŒåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%88%E5%92%8C%E6%A0%88%E5%B8%A7"><span class="toc-number">6.0.1.</span> <span class="toc-text">æ ˆå’Œæ ˆå¸§</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3"><span class="toc-number">6.0.2.</span> <span class="toc-text">å›¾è§£</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">6.0.3.</span> <span class="toc-text">çº¿ç¨‹ä¸Šä¸‹æ–‡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">çº¿ç¨‹å¸¸è§æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#start"><span class="toc-number">7.0.1.</span> <span class="toc-text">start()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getState"><span class="toc-number">7.0.2.</span> <span class="toc-text">getState()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sleep"><span class="toc-number">7.0.3.</span> <span class="toc-text">sleep()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#interrupt"><span class="toc-number">7.0.4.</span> <span class="toc-text">interrupt()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yield"><span class="toc-number">7.0.5.</span> <span class="toc-text">yield()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#join"><span class="toc-number">7.0.6.</span> <span class="toc-text">join()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#wait"><span class="toc-number">7.0.7.</span> <span class="toc-text">wait()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#stop"><span class="toc-number">7.0.8.</span> <span class="toc-text">stop()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#isInterrupted"><span class="toc-number">7.0.9.</span> <span class="toc-text">isInterrupted()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#interrupted"><span class="toc-number">7.0.10.</span> <span class="toc-text">interrupted()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#park"><span class="toc-number">7.0.11.</span> <span class="toc-text">park()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#notify"><span class="toc-number">7.0.12.</span> <span class="toc-text">notify()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#notifyAll"><span class="toc-number">7.0.13.</span> <span class="toc-text">notifyAll()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2cpu%E5%8D%A0%E7%94%A8100"><span class="toc-number">7.0.14.</span> <span class="toc-text">é˜²æ­¢cpuå ç”¨100%</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E5%81%9C%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">7.0.15.</span> <span class="toc-text">ä¸¤é˜¶æ®µåœæ­¢æ¨¡å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.0.16.</span> <span class="toc-text">ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">8.</span> <span class="toc-text">çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.0.1.</span> <span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E7%AE%A1%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">å…±äº«æ¨¡å‹ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-number">9.0.1.</span> <span class="toc-text">å…±äº«é—®é¢˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#synchronized"><span class="toc-number">9.0.2.</span> <span class="toc-text">synchronized</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-number">9.0.3.</span> <span class="toc-text">çº¿ç¨‹å®‰å…¨åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E5%92%8C%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F%E6%98%AF%E5%90%A6%E5%AE%89%E5%85%A8"><span class="toc-number">9.0.3.1.</span> <span class="toc-text">æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦å®‰å…¨</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E6%98%AF%E5%90%A6%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="toc-number">9.0.3.2.</span> <span class="toc-text">å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%AE%89%E5%85%A8%E7%B1%BB"><span class="toc-number">9.0.3.3.</span> <span class="toc-text">å¸¸è§å®‰å…¨ç±»</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">9.0.3.4.</span> <span class="toc-text">ç»ƒä¹ </span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Monitor"><span class="toc-number">9.0.4.</span> <span class="toc-text">Monitor</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">9.0.4.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Java%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="toc-number">9.0.4.2.</span> <span class="toc-text">Javaå¯¹è±¡å¤´</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#synchronized-%E5%8E%9F%E7%90%86"><span class="toc-number">9.0.5.</span> <span class="toc-text">synchronized åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">9.0.5.1.</span> <span class="toc-text">è½»é‡çº§é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%94%81%E8%86%A8%E8%83%80"><span class="toc-number">9.0.5.2.</span> <span class="toc-text">é”è†¨èƒ€</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E4%BC%98%E5%8C%96"><span class="toc-number">9.0.5.3.</span> <span class="toc-text">è‡ªæ—‹ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-number">9.0.5.4.</span> <span class="toc-text">åå‘é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%94%81%E6%B6%88%E9%99%A4"><span class="toc-number">9.0.5.5.</span> <span class="toc-text">é”æ¶ˆé™¤</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#wait-x2F-notify"><span class="toc-number">9.0.6.</span> <span class="toc-text">wait&#x2F;notify</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#wait-%E5%92%8C-sleep-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">9.0.6.1.</span> <span class="toc-text">wait å’Œ sleep çš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%99%9A%E5%81%87%E5%94%A4%E9%86%92"><span class="toc-number">9.0.6.2.</span> <span class="toc-text">è™šå‡å”¤é†’</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C"><span class="toc-number">9.0.7.</span> <span class="toc-text">è®¾è®¡æ¨¡å¼-ä¿æŠ¤æ€§æš‚åœ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%94%9F%E4%BA%A7%E8%80%85-x2F-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">9.0.8.</span> <span class="toc-text">è®¾è®¡æ¨¡å¼-ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">9.0.9.</span> <span class="toc-text">çº¿ç¨‹çŠ¶æ€è½¬æ¢</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B4%BB%E8%B7%83%E6%80%A7"><span class="toc-number">9.0.10.</span> <span class="toc-text">æ´»è·ƒæ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-number">9.0.10.1.</span> <span class="toc-text">æ­»é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E6%AD%BB%E9%94%81"><span class="toc-number">9.0.10.2.</span> <span class="toc-text">å®šä½æ­»é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98"><span class="toc-number">9.0.10.3.</span> <span class="toc-text">å“²å­¦å®¶å°±é¤é—®é¢˜</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B4%BB%E9%94%81"><span class="toc-number">9.0.10.4.</span> <span class="toc-text">æ´»é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF"><span class="toc-number">9.0.10.5.</span> <span class="toc-text">é¥¥é¥¿</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lock"><span class="toc-number">9.0.11.</span> <span class="toc-text">Lock</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Park-amp-Unpark"><span class="toc-number">9.0.12.</span> <span class="toc-text">Park&amp;Unpark</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">9.0.12.1.</span> <span class="toc-text">åŸç†</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8park"><span class="toc-number">9.0.13.</span> <span class="toc-text">è°ƒç”¨park</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8unpark"><span class="toc-number">9.0.14.</span> <span class="toc-text">è°ƒç”¨unpark</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E6%8A%8A%E9%94%81"><span class="toc-number">9.0.15.</span> <span class="toc-text">å¤šæŠŠé”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReentrantLock"><span class="toc-number">10.</span> <span class="toc-text">ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">10.0.1.</span> <span class="toc-text">å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E9%94%81-NonfairSync"><span class="toc-number">10.0.1.1.</span> <span class="toc-text">åŠ é”-NonfairSync</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8A%E6%94%BE-NonfairSync"><span class="toc-number">10.0.1.2.</span> <span class="toc-text">é‡Šæ”¾-NonfairSync</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5-NonfairSync"><span class="toc-number">10.0.1.3.</span> <span class="toc-text">å¯é‡å…¥-NonfairSync</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E6%89%93%E6%96%AD"><span class="toc-number">10.0.1.4.</span> <span class="toc-text">ä¸å¯æ‰“æ–­</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD"><span class="toc-number">10.0.1.5.</span> <span class="toc-text">å¯æ‰“æ–­</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">10.0.1.6.</span> <span class="toc-text">å…¬å¹³é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8D%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">10.0.1.7.</span> <span class="toc-text">ä¸å…¬å¹³é”</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F-await"><span class="toc-number">10.0.1.8.</span> <span class="toc-text">æ¡ä»¶å˜é‡-await</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F-signal"><span class="toc-number">10.0.1.9.</span> <span class="toc-text">æ¡ä»¶å˜é‡-signal</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%94%E2%80%93"><span class="toc-number">10.0.2.</span> <span class="toc-text">â€”â€”â€”â€”â€”â€”â€”â€”â€“</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5"><span class="toc-number">10.0.3.</span> <span class="toc-text">å¯é‡å…¥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E4%B8%AD%E6%96%AD"><span class="toc-number">10.0.4.</span> <span class="toc-text">å¯ä¸­æ–­</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">10.0.5.</span> <span class="toc-text">å¯è®¾ç½®è¶…æ—¶æ—¶é—´</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E8%AE%BE%E7%BD%AE%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">10.0.6.</span> <span class="toc-text">å¯è®¾ç½®å…¬å¹³é”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">10.0.7.</span> <span class="toc-text">æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReentrantReadWriteLock"><span class="toc-number">11.</span> <span class="toc-text">ReentrantReadWriteLock</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">11.0.1.</span> <span class="toc-text">æµ‹è¯•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">11.0.2.</span> <span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E9%A1%B92-%E5%AE%98%E6%96%B9%E8%A7%A3%E5%86%B3%E4%BE%8B%E5%AD%90"><span class="toc-number">11.0.3.</span> <span class="toc-text">äº‹é¡¹2-å®˜æ–¹è§£å†³ä¾‹å­</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81%E5%BA%94%E7%94%A8"><span class="toc-number">11.0.4.</span> <span class="toc-text">è¯»å†™é”åº”ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#StampedLock"><span class="toc-number">11.0.4.1.</span> <span class="toc-text">StampedLock</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-1"><span class="toc-number">11.0.5.</span> <span class="toc-text">å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E9%94%81-%E5%86%99"><span class="toc-number">11.0.5.1.</span> <span class="toc-text">åŠ é”-å†™</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E9%94%81-%E8%AF%BB"><span class="toc-number">11.0.5.2.</span> <span class="toc-text">åŠ é”-è¯»</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8A%E6%94%BE-%E5%86%99"><span class="toc-number">11.0.5.3.</span> <span class="toc-text">é‡Šæ”¾-å†™</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8A%E6%94%BE-%E8%AF%BB"><span class="toc-number">11.0.5.4.</span> <span class="toc-text">é‡Šæ”¾-è¯»</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StampedLock-1"><span class="toc-number">12.</span> <span class="toc-text">StampedLock</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">12.0.1.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">12.0.2.</span> <span class="toc-text">åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#writeLock"><span class="toc-number">12.0.2.1.</span> <span class="toc-text">writeLock()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore"><span class="toc-number">13.</span> <span class="toc-text">Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">13.0.1.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">13.0.2.</span> <span class="toc-text">é‡å†™è¿æ¥æ± </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">13.0.3.</span> <span class="toc-text">åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E9%94%81-%E5%85%AC%E5%B9%B3"><span class="toc-number">13.0.3.1.</span> <span class="toc-text">åŠ é”-å…¬å¹³</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8A%E6%94%BE-%E5%85%AC%E5%B9%B3"><span class="toc-number">13.0.3.2.</span> <span class="toc-text">é‡Šæ”¾-å…¬å¹³</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CountdownLatch"><span class="toc-number">14.</span> <span class="toc-text">CountdownLatch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">14.0.1.</span> <span class="toc-text">ç®€å•ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">14.0.2.</span> <span class="toc-text">åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#countDown"><span class="toc-number">14.0.2.1.</span> <span class="toc-text">countDown()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#await"><span class="toc-number">14.0.2.2.</span> <span class="toc-text">await()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CyclicBarrier"><span class="toc-number">15.</span> <span class="toc-text">CyclicBarrier</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-1"><span class="toc-number">15.0.1.</span> <span class="toc-text">ç®€å•ä½¿ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-5"><span class="toc-number">15.0.2.</span> <span class="toc-text">åŸç†</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%A1%BA%E5%BA%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">16.</span> <span class="toc-text">åŒæ­¥é¡ºåºæ§åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#wait-notify%E7%89%88%E6%9C%AC"><span class="toc-number">16.0.1.</span> <span class="toc-text">wait notifyç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#park-unpark-%E7%89%88%E6%9C%AC"><span class="toc-number">16.0.2.</span> <span class="toc-text">park unpark ç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#await-signal-%E7%89%88%E6%9C%AC"><span class="toc-number">16.0.3.</span> <span class="toc-text">await signal ç‰ˆæœ¬</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%9B%BF%E8%BE%93%E5%87%BA"><span class="toc-number">17.</span> <span class="toc-text">äº¤æ›¿è¾“å‡º</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#wait-notify%E7%89%88%E6%9C%AC-1"><span class="toc-number">17.0.1.</span> <span class="toc-text">wait notifyç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#park-unpark-%E7%89%88%E6%9C%AC-1"><span class="toc-number">17.0.2.</span> <span class="toc-text">park unpark ç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#await-signal-%E7%89%88%E6%9C%AC-1"><span class="toc-number">17.0.3.</span> <span class="toc-text">await signal ç‰ˆæœ¬</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">18.</span> <span class="toc-text">å…±äº«å†…å­˜æ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">18.0.1.</span> <span class="toc-text">Javaå†…å­˜æ¨¡å‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F-volatile%E7%89%88"><span class="toc-number">18.0.2.</span> <span class="toc-text">ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ volatileç‰ˆ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F-Balking"><span class="toc-number">18.0.3.</span> <span class="toc-text">åŒæ­¥æ¨¡å¼ Balking</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96"><span class="toc-number">18.0.4.</span> <span class="toc-text">æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#volatile-%E5%8E%9F%E7%90%86"><span class="toc-number">18.0.5.</span> <span class="toc-text">volatile åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%99%E5%B1%8F%E9%9A%9C"><span class="toc-number">18.0.5.1.</span> <span class="toc-text">å†™å±éšœ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%BB%E5%B1%8F%E9%9A%9C"><span class="toc-number">18.0.5.2.</span> <span class="toc-text">è¯»å±éšœ</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#double-check-locking-%E9%97%AE%E9%A2%98"><span class="toc-number">18.0.6.</span> <span class="toc-text">double check locking é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E6%97%A0%E9%94%81"><span class="toc-number">19.</span> <span class="toc-text">å…±äº«æ¨¡å‹ä¹‹æ— é”</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CAS%E4%B8%8Evolatile"><span class="toc-number">19.0.1.</span> <span class="toc-text">CASä¸volatile</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B4%E6%95%B0"><span class="toc-number">19.0.2.</span> <span class="toc-text">åŸå­æ•´æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E5%BC%95%E7%94%A8"><span class="toc-number">19.0.3.</span> <span class="toc-text">åŸå­å¼•ç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ABA%E9%97%AE%E9%A2%98"><span class="toc-number">19.0.4.</span> <span class="toc-text">ABAé—®é¢˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B0%E7%BB%84"><span class="toc-number">19.0.5.</span> <span class="toc-text">åŸå­æ•°ç»„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%9B%B4%E6%96%B0%E5%99%A8"><span class="toc-number">19.0.6.</span> <span class="toc-text">å­—æ®µæ›´æ–°å™¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E7%B4%AF%E5%8A%A0%E5%99%A8"><span class="toc-number">19.0.7.</span> <span class="toc-text">åŸå­ç´¯åŠ å™¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LongAdder-%E6%BA%90%E7%A0%81"><span class="toc-number">19.0.8.</span> <span class="toc-text">LongAdder æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Unsafe"><span class="toc-number">19.0.9.</span> <span class="toc-text">Unsafe</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-number">20.</span> <span class="toc-text">ä¸å¯å˜</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DateTimeFormatter"><span class="toc-number">20.0.1.</span> <span class="toc-text">DateTimeFormatter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">20.0.2.</span> <span class="toc-text">ä¸å¯å˜å¯¹è±¡è®¾è®¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#final%E5%8E%9F%E7%90%86"><span class="toc-number">20.0.3.</span> <span class="toc-text">finalåŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%8B%E5%86%99-%E7%AE%80%E5%8D%95%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">20.0.4.</span> <span class="toc-text">æ‰‹å†™-ç®€å•è¿æ¥æ± </span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">21.</span> <span class="toc-text">çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A4%A7%E6%A6%82%E6%89%A7%E8%A1%8C%E6%AD%A5%E9%AA%A4"><span class="toc-number">21.0.1.</span> <span class="toc-text">çº¿ç¨‹æ± å¤§æ¦‚æ‰§è¡Œæ­¥éª¤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0"><span class="toc-number">21.0.2.</span> <span class="toc-text">è‡ªå®šä¹‰çº¿ç¨‹æ± å®ç°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-number">21.0.3.</span> <span class="toc-text">ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">21.0.3.1.</span> <span class="toc-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#JDK%E4%B8%AD%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">21.0.3.2.</span> <span class="toc-text">JDKä¸­æ‹’ç»ç­–ç•¥çš„å®ç°ç±»</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Executors"><span class="toc-number">21.0.4.</span> <span class="toc-text">Executors</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#newFixedThreadPool"><span class="toc-number">21.0.4.1.</span> <span class="toc-text">newFixedThreadPool</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#newCachedThreadPool"><span class="toc-number">21.0.4.2.</span> <span class="toc-text">newCachedThreadPool</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#newSingleThreadExecutor"><span class="toc-number">21.0.4.3.</span> <span class="toc-text">newSingleThreadExecutor</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-number">21.0.5.</span> <span class="toc-text">æäº¤ä»»åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#submit"><span class="toc-number">21.0.5.1.</span> <span class="toc-text">submit()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#invokeAll"><span class="toc-number">21.0.5.2.</span> <span class="toc-text">invokeAll()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#invokeAny"><span class="toc-number">21.0.5.3.</span> <span class="toc-text">invokeAny()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#shutdown"><span class="toc-number">21.0.5.4.</span> <span class="toc-text">shutdown()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#shutdownnow"><span class="toc-number">21.0.5.5.</span> <span class="toc-text">shutdownnow()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">21.0.6.</span> <span class="toc-text">å·¥ä½œçº¿ç¨‹æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF-%E5%9B%BA%E5%AE%9A%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">21.0.6.1.</span> <span class="toc-text">é¥¥é¥¿-å›ºå®šçº¿ç¨‹æ± </span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%B0%91%E7%BA%BF%E7%A8%8B%E5%90%88%E9%80%82"><span class="toc-number">21.0.7.</span> <span class="toc-text">åˆ›å»ºå¤šå°‘çº¿ç¨‹åˆé€‚</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">21.0.8.</span> <span class="toc-text">ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Timer"><span class="toc-number">21.0.8.1.</span> <span class="toc-text">Timer</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ScheduledThreadPoolExecutor"><span class="toc-number">21.0.8.2.</span> <span class="toc-text">ScheduledThreadPoolExecutor</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Fork-x2F-Join"><span class="toc-number">21.0.9.</span> <span class="toc-text">Fork&#x2F;Join</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS"><span class="toc-number">22.</span> <span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81"><span class="toc-number">22.0.1.</span> <span class="toc-text">æ‰‹å†™ä¸€ä¸ªä¸å¯é‡å…¥é”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal"><span class="toc-number">23.</span> <span class="toc-text">ThreadLocal</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-6"><span class="toc-number">23.0.1.</span> <span class="toc-text">åŸç†</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88%E7%B1%BB"><span class="toc-number">24.</span> <span class="toc-text">çº¿ç¨‹å®‰å…¨é›†åˆç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Collections"><span class="toc-number">24.0.1.</span> <span class="toc-text">Collections</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HashMap-JDK7-%E6%89%A9%E5%AE%B9%E6%AD%BB%E9%93%BE"><span class="toc-number">24.0.2.</span> <span class="toc-text">HashMap-JDK7-æ‰©å®¹æ­»é“¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ConcurrentHashMap"><span class="toc-number">24.0.3.</span> <span class="toc-text">ConcurrentHashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">24.0.3.1.</span> <span class="toc-text">æ„é€ å™¨</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#get"><span class="toc-number">24.0.3.2.</span> <span class="toc-text">get()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#put"><span class="toc-number">24.0.3.3.</span> <span class="toc-text">put()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#initTable"><span class="toc-number">24.0.3.4.</span> <span class="toc-text">initTable()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#casTabAt"><span class="toc-number">24.0.3.5.</span> <span class="toc-text">casTabAt()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#helpTransfer"><span class="toc-number">24.0.3.6.</span> <span class="toc-text">helpTransfer()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#transfer"><span class="toc-number">24.0.3.7.</span> <span class="toc-text">transfer()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#COpy"><span class="toc-number">24.0.4.</span> <span class="toc-text">COpy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97"><span class="toc-number">25.</span> <span class="toc-text">é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LinkedBlockingQueue"><span class="toc-number">25.1.</span> <span class="toc-text">LinkedBlockingQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-7"><span class="toc-number">25.1.1.</span> <span class="toc-text">åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#put-1"><span class="toc-number">25.1.1.1.</span> <span class="toc-text">put()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#poll"><span class="toc-number">25.1.1.2.</span> <span class="toc-text">poll()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConcurrentLinkedQueue"><span class="toc-number">25.2.</span> <span class="toc-text">ConcurrentLinkedQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-8"><span class="toc-number">25.2.1.</span> <span class="toc-text">åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#add"><span class="toc-number">25.2.1.1.</span> <span class="toc-text">add()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exchanger"><span class="toc-number">26.</span> <span class="toc-text">Exchanger</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">26.0.1.</span> <span class="toc-text">ä½¿ç”¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CompletableFuture"><span class="toc-number">27.</span> <span class="toc-text">CompletableFuture</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0"><span class="toc-number">27.0.1.</span> <span class="toc-text">æ„é€ </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95"><span class="toc-number">27.0.2.</span> <span class="toc-text">æ–¹æ³•</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2023/09/21/JVM/" title="JVM"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_41.webp" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="JVM"/></a><div class="content"><a class="title" href="/blog/2023/09/21/JVM/" title="JVM">JVM</a><time datetime="2023-09-21T10:09:32.000Z" title="å‘è¡¨äº 2023-09-21 18:09:32">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2023/09/17/node%E5%A4%9A%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86/" title="nodeå¤šç‰ˆæœ¬ç®¡ç†"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_33.webp" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="nodeå¤šç‰ˆæœ¬ç®¡ç†"/></a><div class="content"><a class="title" href="/blog/2023/09/17/node%E5%A4%9A%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86/" title="nodeå¤šç‰ˆæœ¬ç®¡ç†">nodeå¤šç‰ˆæœ¬ç®¡ç†</a><time datetime="2023-09-17T06:09:30.000Z" title="å‘è¡¨äº 2023-09-17 14:09:30">2023-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2023/09/16/Spring%E6%98%AF%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84/" title="Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_48.webp" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„"/></a><div class="content"><a class="title" href="/blog/2023/09/16/Spring%E6%98%AF%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84/" title="Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„">Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„</a><time datetime="2023-09-16T12:09:34.000Z" title="å‘è¡¨äº 2023-09-16 20:09:34">2023-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2023/09/07/Mybatis%E6%B3%A8%E5%86%8C%E6%8F%92%E4%BB%B6/" title="Mybatisæ³¨å†Œæ’ä»¶"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_24.webp" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Mybatisæ³¨å†Œæ’ä»¶"/></a><div class="content"><a class="title" href="/blog/2023/09/07/Mybatis%E6%B3%A8%E5%86%8C%E6%8F%92%E4%BB%B6/" title="Mybatisæ³¨å†Œæ’ä»¶">Mybatisæ³¨å†Œæ’ä»¶</a><time datetime="2023-09-07T03:09:38.000Z" title="å‘è¡¨äº 2023-09-07 11:09:38">2023-09-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2023/09/04/HaSee%E7%AC%94%E8%AE%B0%E6%9C%AC%E8%9C%82%E9%B8%A3%E6%8A%A5%E8%AD%A6%E5%A4%84%E7%90%86/" title="HaSeeç¬”è®°æœ¬èœ‚é¸£æŠ¥è­¦å¤„ç†"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.fomal.cc/img/default_cover_26.webp" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="HaSeeç¬”è®°æœ¬èœ‚é¸£æŠ¥è­¦å¤„ç†"/></a><div class="content"><a class="title" href="/blog/2023/09/04/HaSee%E7%AC%94%E8%AE%B0%E6%9C%AC%E8%9C%82%E9%B8%A3%E6%8A%A5%E8%AD%A6%E5%A4%84%E7%90%86/" title="HaSeeç¬”è®°æœ¬èœ‚é¸£æŠ¥è­¦å¤„ç†">HaSeeç¬”è®°æœ¬èœ‚é¸£æŠ¥è­¦å¤„ç†</a><time datetime="2023-09-04T04:09:05.000Z" title="å‘è¡¨äº 2023-09-04 12:09:05">2023-09-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script defer data-pjax src="https://boluokk.gitee.io/blog/js/cat.js"></script><script defer src="https://boluokk.gitee.io/blog/js/cursor.js"></script><script async data-pjax src="https://boluokk.gitee.io/blog/js/txmap.js"></script><canvas id="universe"></canvas><script defer src="https://boluokk.gitee.io/blog/js/universe.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="ğŸ,ğŸ‰ğŸˆ,ğŸ‡ğŸ¥¥,ğŸ¥,ğŸŠğŸ‹,ğŸ¥ğŸŠğŸ‹ğŸŒ" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo_v5.4.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.2.2" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('å·²æŒ‚è½½butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/blog/js/footer-username.js"></script><!-- hexo injector body_end end --></body></html>